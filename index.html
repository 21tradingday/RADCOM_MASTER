<!DOCTYPE html>
<html lang="es">
<head>   
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RADCOM MASTER v4.7 - SISTEMA DE COMUNICACIÓN SEGURA</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* === ESTILOS ORIGINALES - SIN CAMBIOS === */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body { 
            background: #0a0a0a; 
            color: #00ff88; 
            font-family: 'Consolas', 'Courier New', monospace; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container { 
            width: 640px; 
            height: 640px; 
            border: 2px solid #1a1a1a; 
            background: linear-gradient(145deg, #050505 0%, #0a0a0a 100%);
            display: flex; 
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, 
                #ff3300 0%, 
                #00ff88 25%, 
                #0088ff 50%, 
                #00ff88 75%, 
                #ff3300 100%);
            z-index: 100;
        }
        
        .header-pro { 
            height: 48px;
            background: linear-gradient(90deg, #000 0%, #111 100%); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 12px;
            border-bottom: 2px solid #00ff88; 
            font-size: 0.75rem;
            position: relative;
            z-index: 10;
        }
        
        .version-badge {
            display: inline-block;
            background: linear-gradient(45deg, #ff3300, #ff6600);
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 0.8rem;
            margin-left: 6px;
            box-shadow: 0 2px 4px rgba(255, 51, 0, 0.3);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot-live {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #00ff88;
            box-shadow: 0 0 6px #00ff88;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .main-layout { 
            display: flex; 
            flex: 1; 
            overflow: hidden; 
            height: calc(640px - 48px - 120px);
        }
        
        .sidebar { 
            width: 175px;
            border-right: 1px solid #222; 
            background: rgba(8, 8, 8, 0.9); 
            display: flex; 
            flex-direction: column;
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }
        
        .sidebar-section {
            margin: 6px 0;
            border-bottom: 1px solid #222;
            padding-bottom: 6px;
        }
        
        .sidebar-title { 
            padding: 5px 8px;
            font-size: 0.7rem;
            background: rgba(17, 17, 17, 0.8); 
            color: #00ff88; 
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border-bottom: 1px solid #00ff88; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .peer-item { 
            padding: 5px 8px;
            font-size: 0.65rem;
            cursor: pointer; 
            border-bottom: 1px solid rgba(34, 34, 34, 0.5); 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .peer-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, rgba(0, 255, 136, 0.1), transparent);
            transition: width 0.3s ease;
        }
        
        .peer-item:hover::before {
            width: 100%;
        }
        
        .peer-item.active { 
            background: linear-gradient(90deg, rgba(0, 255, 136, 0.15), transparent);
            border-left: 2px solid #00ff88;
        }
        
        .peer-info { 
            display: flex; 
            align-items: center; 
            gap: 5px;
            overflow: hidden;
            flex: 1;
        }
        
        .status-dot { 
            width: 5px;
            height: 5px;
            border-radius: 50%; 
            flex-shrink: 0; 
        }
        
        .st-online { 
            background: #00ff88 !important; 
            box-shadow: 0 0 4px #00ff88 !important;
        }
        
        .st-offline { 
            background: #ff3300 !important; 
            opacity: 0.5; 
        }
        
        .st-encrypted {
            background: #0088ff !important;
            box-shadow: 0 0 4px #0088ff !important;
        }
        
        /* NUEVO ESTADO: NARANJA PARA INACTIVO/SEGUNDO PLANO */
        .st-warning { 
            background: #ffaa00 !important; 
            box-shadow: 0 0 6px #ffaa00 !important;
            animation: pulseWarning 1s infinite;
        }
        
        @keyframes pulseWarning {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .del-btn { 
            color: #666; 
            font-weight: bold; 
            padding: 1px 4px;
            cursor: pointer; 
            font-size: 0.7rem;
            border-radius: 2px;
            transition: all 0.3s;
            z-index: 2;
            position: relative;
        }
        
        .del-btn:hover { 
            background: #ff3300; 
            color: white;
        }

        .content-area { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: #000; 
            overflow: hidden;
        }
        
        .monitor-container {
            display: flex;
            flex-direction: column;
            height: 285px;
            position: relative;
        }
        
        #monitor-raw { 
            min-height: 28px;
            padding: 5px;
            font-size: 0.65rem;
            color: #00ff88; 
            background: rgba(0, 20, 0, 0.3); 
            border: 1px solid #222; 
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            margin: 6px 8px;
            overflow-y: auto;
            max-height: 55px;
        }
        
        .resizable-separator {
            height: 5px;
            background: linear-gradient(90deg, #333, #00ff88, #0088ff, #00ff88, #333);
            margin: 2px 8px;
            cursor: row-resize;
            position: relative;
            transition: all 0.3s;
        }
        
        .resizable-separator:hover {
            background: linear-gradient(90deg, #333, #00ff88, #0088ff, #00ff88, #333);
            height: 6px;
        }
        
        .resizable-separator::after {
            content: "════════════════════════════════════════";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #00ff88;
            font-size: 5px;
            letter-spacing: 0.2px;
            opacity: 0.7;
        }
        
        .table-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 0 8px 4px 8px;
            min-height: 100px;
            overflow: hidden;
        }
        
        .table-info {
            display: flex;
            justify-content: space-between;
            padding: 3px 5px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 2px;
            font-size: 0.55rem;
            color: #00ffea;
            align-items: center;
            margin-bottom: 2px;
            height: 26px;
        }
        
        .char-preview {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .preview-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 45px;
        }
        
        .preview-label {
            font-size: 0.45rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.1px;
        }
        
        .preview-value {
            font-size: 0.7rem;
            font-weight: bold;
            margin-top: 0.5px;
        }
        
        .ansi-container { 
            flex: 1;
            padding: 3px;
            background: rgba(5, 5, 5, 0.95); 
            border: 1px solid #00ff88; 
            border-radius: 2px;
            position: relative;
            overflow: hidden;
        }
        
        .ansi-container::before {
            content: 'TABLA ASCII v4.5';
            position: absolute;
            top: -4px;
            left: 5px;
            background: #000;
            color: #00ff88;
            font-size: 0.5rem;
            padding: 0 3px;
            z-index: 1;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.45rem;
            text-align: center; 
            color: #00ff88; 
            cursor: pointer; 
            table-layout: fixed;
            height: 100%;
        }
        
        th, td { 
            border: 1px solid rgba(34, 34, 34, 0.8); 
            padding: 0.3px;
            color: #888; 
            transition: all 0.3s ease; 
            position: relative; 
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            height: 11px;
            line-height: 0.9;
        }
        
        th {
            color: #00ff88;
            background: rgba(0, 0, 0, 0.8);
            font-weight: bold;
            padding: 1px 0.3px;
            text-transform: uppercase;
            letter-spacing: 0.1px;
            height: 12px;
        }
        
        td:hover { 
            background: rgba(0, 255, 136, 0.1); 
            color: #fff; 
            border-color: #00ff88; 
            transform: scale(1.02);
            z-index: 1;
            box-shadow: 0 0 3px rgba(0, 255, 136, 0.3);
        }
        
        td.selected { 
            background: rgba(0, 255, 136, 0.2) !important; 
            color: #00ff88 !important; 
            border-color: #00ff88 !important; 
            box-shadow: 0 0 6px rgba(0, 255, 136, 0.5);
            font-weight: bold; 
            z-index: 2;
        }
        
        td.highlighted {
            background: rgba(255, 100, 0, 0.2) !important;
            color: #ff6600 !important;
            border-color: #ff6600 !important;
            box-shadow: 0 0 6px rgba(255, 100, 0, 0.5);
        }
        
        .row-idx { 
            color: #00ff88; 
            font-weight: bold; 
            background: rgba(0, 0, 0, 0.9); 
            border-right: 1px solid #00ff88;
            width: 12px;
            cursor: default; 
            text-transform: uppercase;
            font-size: 0.45rem;
        }
        
        #monitor-decoded { 
            flex: 1; 
            padding: 3px 6px;
            overflow-y: auto;
            font-size: 0.65rem;
            background: rgba(2, 2, 2, 0.95); 
            color: #fff; 
            border-top: 1px solid #222;
            line-height: 1.05;
            max-height: calc(640px - 48px - 285px - 120px);
        }
        
        #monitor-decoded::-webkit-scrollbar,
        #monitor-raw::-webkit-scrollbar {
            width: 3px;
        }

        #monitor-decoded::-webkit-scrollbar-track,
        #monitor-raw::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 1.5px;
        }

        #monitor-decoded::-webkit-scrollbar-thumb,
        #monitor-raw::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.5);
            border-radius: 1.5px;
        }

        #monitor-decoded::-webkit-scrollbar-thumb:hover,
        #monitor-raw::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 136, 0.7);
        }
        
        .message-bubble {
            margin: 2px 0;
            padding: 3px 5px;
            border-radius: 2px;
            max-width: 96%;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(2px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-outgoing {
            background: linear-gradient(135deg, rgba(0, 136, 255, 0.2), rgba(0, 255, 136, 0.1));
            border-left: 1px solid #0088ff;
            margin-left: auto;
        }
        
        .message-incoming {
            background: linear-gradient(135deg, rgba(255, 51, 0, 0.1), rgba(255, 102, 0, 0.05));
            border-left: 1px solid #ff3300;
        }
        
        .message-system {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
            border-left: 1px solid #00ff88;
            text-align: center;
            font-style: italic;
            color: #888;
            font-size: 0.6rem;
        }
        
        .footer-pro { 
            background: linear-gradient(180deg, #111 0%, #000 100%);
            border-top: 1px solid #00ff88;
            height: 120px;
        }
        
        .input-controls {
            display: flex;
            background: rgba(0, 0, 0, 0.9);
            padding: 4px 5px;
            gap: 4px;
            align-items: center;
            border-bottom: 1px solid #222;
            height: 36px;
        }
        
        #inputMsg { 
            flex: 1; 
            background: rgba(0, 0, 0, 0.8); 
            border: 1px solid #333; 
            color: #00ff88; 
            padding: 5px 7px;
            font-size: 0.75rem;
            outline: none; 
            font-family: 'Courier New', monospace; 
            border-radius: 2px;
            transition: all 0.3s;
        }
        
        #inputMsg:focus { 
            border-color: #00ff88; 
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.2);
        }
        
        #sendBtn { 
            background: linear-gradient(135deg, #00ff88 0%, #0088ff 100%); 
            color: #000; 
            border: none; 
            padding: 5px 10px;
            font-weight: bold; 
            cursor: pointer; 
            font-size: 0.7rem;
            border-radius: 2px;
            text-transform: uppercase;
            letter-spacing: 0.2px;
            transition: all 0.3s;
            min-width: 85px;
        }
        
        #sendBtn:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 2px 8px rgba(0, 255, 136, 0.3);
        }
        
        .btn-header { 
            background: linear-gradient(135deg, #222 0%, #333 100%); 
            color: #00ff88; 
            border: 1px solid #333; 
            padding: 2px 5px;
            font-size: 0.55rem;
            cursor: pointer; 
            border-radius: 2px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.1px;
        }
        
        .btn-header:hover { 
            background: linear-gradient(135deg, #333 0%, #444 100%); 
            border-color: #00ff88;
        }
        
        .clear-chat-btn {
            background: linear-gradient(135deg, #333 0%, #444 100%);
            color: #ff3300;
            border: 1px solid #444;
            padding: 2px 5px;
            font-size: 0.55rem;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.3s;
        }
        
        .clear-chat-btn:hover {
            background: linear-gradient(135deg, #ff3300 0%, #ff6600 100%);
            color: white;
            border-color: #ff3300;
        }
        
        .security-badge {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            background: rgba(0, 136, 255, 0.2);
            padding: 1px 3px;
            border-radius: 2px;
            font-size: 0.5rem;
            border: 1px solid rgba(0, 136, 255, 0.5);
        }
        
        .stats-panel {
            display: flex;
            gap: 10px;
            padding: 3px 8px;
            background: rgba(0, 0, 0, 0.9);
            border-top: 1px solid #222;
            font-size: 0.55rem;
            color: #888;
            justify-content: space-around;
            height: 30px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 0.8rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .stat-label {
            font-size: 0.45rem;
            text-transform: uppercase;
            letter-spacing: 0.1px;
        }
        
        .encryption-indicator {
            display: flex;
            align-items: center;
            gap: 2px;
            color: #0088ff;
            font-size: 0.55rem;
        }
        
        select {
            background: #000;
            color: #00ff88;
            border: 1px solid #333;
            font-size: 0.6rem;
            padding: 3px 5px;
            border-radius: 2px;
            outline: none;
            min-width: 85px;
            height: 26px;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(145deg, #050505 0%, #0a0a0a 100%);
            border: 2px solid #00ff88;
            border-radius: 5px;
            padding: 12px;
            max-width: 450px;
            width: 100%;
            color: #00ff88;
        }
        
        .modal-title {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #00ff88;
            text-align: center;
        }
        
        .modal-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: #ff3300;
            font-size: 1.1rem;
            cursor: pointer;
        }
        
        input[type="password"], input[type="text"] {
            background: rgba(0, 0, 0, 0.8);
            color: #00ff88;
            border: 1px solid #333;
            padding: 4px 6px;
            border-radius: 2px;
            outline: none;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
        }
        
        .connection-type-selector {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }
        
        .connection-type-btn {
            flex: 1;
            padding: 8px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            color: #888;
            border-radius: 3px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 0.7rem;
        }
        
        .connection-type-btn.active {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            color: #00ff88;
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.3);
        }
        
        .connection-type-btn:hover:not(.active) {
            border-color: #0088ff;
            color: #0088ff;
        }
        
        .connection-icon {
            display: block;
            font-size: 1.2rem;
            margin-bottom: 3px;
        }
        
        .connection-info {
            font-size: 0.6rem;
            color: #888;
            margin-top: 3px;
            text-align: center;
        }
        
        /* === BOTÓN REFRESCAR PEQUEÑO COMO ANTES === */
        .btn-refresh {
            background: linear-gradient(135deg, #ff6600 0%, #ff3300 100%) !important;
            color: white !important;
            border: none !important;
            width: auto !important;
            min-width: auto !important;
            padding: 2px 5px !important;
        }
        
        .btn-refresh:hover {
            background: linear-gradient(135deg, #ff8800 0%, #ff5500 100%) !important;
            transform: scale(1.05);
        }
        
        /* === AÑADIDO: CSS PARA EL SCROLL === */
        #saved-peers-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(34, 34, 34, 0.5);
            margin: 4px;
            border-radius: 3px;
            background: rgba(5, 5, 5, 0.7);
        }

        #saved-peers {
            padding: 2px;
        }

        #saved-peers-container::-webkit-scrollbar {
            width: 4px;
        }

        #saved-peers-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2px;
        }

        #saved-peers-container::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.5);
            border-radius: 2px;
        }

        #saved-peers-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 136, 0.7);
        }

        /* === BOTÓN REVIVIR CONEXIONES MEJORADO === */
        .revive-btn {
            width: 100%;
            padding: 3px;
            margin-top: 5px;
            background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
            color: #000;
            border: none;
            border-radius: 2px;
            font-size: 0.55rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            font-weight: bold;
        }

        .revive-btn:hover {
            background: linear-gradient(135deg, #ffbb00 0%, #ff9900 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(255, 170, 0, 0.3);
        }

        .revive-btn:active {
            transform: translateY(0);
        }

        /* === INDICADOR DE REVIVIR ACTIVO === */
        .reviving {
            animation: revivingPulse 0.5s infinite;
        }

        @keyframes revivingPulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Nuevos estilos para pestañas */
        .tab-container {
            display: flex;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 1px solid #333;
        }

        .tab-button {
            flex: 1;
            padding: 3px 5px;
            background: rgba(17, 17, 17, 0.8);
            color: #888;
            border: none;
            cursor: pointer;
            font-size: 0.55rem;
            text-transform: uppercase;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: rgba(0, 255, 136, 0.15);
            color: #00ff88;
            border-bottom: 2px solid #00ff88;
        }

        .tab-button:hover {
            background: rgba(0, 255, 136, 0.1);
        }

        .tab-content {
            display: none;
            height: 100%;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        /* Ajustes para tamaños de fuentes y contenedores */
        .preview-value {
            font-size: 0.7rem; /* Ajustado */
        }

        .preview-label {
            font-size: 0.45rem; /* Ajustado */
        }

        /* === NUEVOS ESTILOS PARA TABLA MORSE MEJORADA === */
        .morse-table-container {
            padding: 3px;
            height: 100%;
            overflow-y: auto;
        }

        /* SCROLL ESTILIZADO PARA LAS PESTAÑAS */
        .morse-table-container::-webkit-scrollbar,
        .tab-content::-webkit-scrollbar {
            width: 4px;
        }

        .morse-table-container::-webkit-scrollbar-track,
        .tab-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2px;
        }

        .morse-table-container::-webkit-scrollbar-thumb,
        .tab-content::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.5);
            border-radius: 2px;
        }

        .morse-table-container::-webkit-scrollbar-thumb:hover,
        .tab-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 136, 0.7);
        }

        #morseTable {
            font-size: 0.5rem;
            width: 100%;
            border-collapse: collapse;
        }

        #morseTable th {
            background: rgba(0, 0, 0, 0.9);
            padding: 3px;
            font-weight: bold;
            border: 1px solid #333;
        }

        #morseTable td {
            padding: 4px 2px;
            border: 1px solid #333;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        #morseTable td:hover {
            background: rgba(0, 255, 136, 0.1);
            color: #fff;
            border-color: #00ff88;
        }

        .morse-char {
            color: #00ff88;
            font-weight: bold;
            font-size: 0.6rem;
        }

        .morse-code {
            color: #0088ff;
            font-family: 'Courier New', monospace;
            font-size: 0.55rem;
        }

        .phonetic-example {
            color: #ffaa00;
            font-size: 0.5rem;
        }

        .play-morse-btn {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            color: #00ff88;
            padding: 1px 4px;
            font-size: 0.4rem;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .play-morse-btn:hover {
            background: rgba(0, 255, 136, 0.4);
            transform: scale(1.05);
        }

        /* === CONTROLES DE SONIDO MORSE === */
        .morse-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 5px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 2px;
            margin-bottom: 3px;
            font-size: 0.5rem;
        }

        .morse-speed-controls {
            display: flex;
            gap: 4px;
        }

        .speed-btn {
            padding: 2px 4px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            color: #888;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.45rem;
            transition: all 0.2s;
        }

        .speed-btn.active {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            color: #00ff88;
        }

        .speed-btn:hover {
            border-color: #0088ff;
            color: #0088ff;
        }

        .test-play-btn {
            padding: 2px 6px;
            background: linear-gradient(135deg, #ff6600 0%, #ff3300 100%);
            color: white;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.45rem;
            transition: all 0.2s;
        }

        .test-play-btn:hover {
            background: linear-gradient(135deg, #ff8800 0%, #ff5500 100%);
            transform: translateY(-1px);
        }

        .audio-status {
            display: flex;
            align-items: center;
            gap: 3px;
            color: #00ff88;
        }

        .audio-status i {
            font-size: 0.6rem;
        }

        /* === ESTILOS ORIGINALES PARA PESTAÑA RADIO v4.6 === */
        .radio-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 3px;
            gap: 5px;
        }

        .radio-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .frequency-input-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 3px;
            padding: 5px;
        }

        .frequency-label {
            font-size: 0.5rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .frequency-display {
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            color: #00ff88;
            text-align: center;
            background: rgba(0, 20, 0, 0.3);
            border: 1px solid #222;
            padding: 3px;
            border-radius: 2px;
            margin-bottom: 3px;
            letter-spacing: 1px;
        }

        .frequency-input-row {
            display: flex;
            gap: 3px;
            align-items: center;
        }

        .frequency-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            color: #00ff88;
            padding: 3px 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            border-radius: 2px;
            outline: none;
        }

        .frequency-input:focus {
            border-color: #00ff88;
            box-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
        }

        .unit-selector {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            color: #00ff88;
            padding: 3px 5px;
            font-size: 0.6rem;
            border-radius: 2px;
            min-width: 50px;
        }

        .tune-buttons {
            display: flex;
            gap: 2px;
            margin-top: 3px;
        }

        .tune-btn {
            flex: 1;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            color: #00ff88;
            padding: 2px;
            font-size: 0.6rem;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
        }

        .tune-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }

        .band-selector-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 3px;
            padding: 5px;
        }

        .band-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            margin-bottom: 5px;
        }

        .band-btn {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            color: #888;
            padding: 4px 2px;
            font-size: 0.55rem;
            cursor: pointer;
            border-radius: 2px;
            text-align: center;
            transition: all 0.2s;
        }

        .band-btn:hover {
            border-color: #0088ff;
            color: #0088ff;
        }

        .band-btn.active {
            background: rgba(0, 136, 255, 0.2);
            border-color: #0088ff;
            color: #0088ff;
            box-shadow: 0 0 5px rgba(0, 136, 255, 0.3);
        }

        .hf-bands {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            margin-top: 3px;
        }

        .hf-band-btn {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #444;
            color: #ffaa00;
            padding: 3px 1px;
            font-size: 0.45rem;
            cursor: pointer;
            border-radius: 1px;
            text-align: center;
            transition: all 0.2s;
        }

        .hf-band-btn:hover {
            background: rgba(255, 170, 0, 0.1);
            border-color: #ffaa00;
        }

        .hf-band-btn.active {
            background: rgba(255, 170, 0, 0.2);
            border-color: #ffaa00;
            color: #ffaa00;
            box-shadow: 0 0 4px rgba(255, 170, 0, 0.3);
        }

        .active-frequency-display {
            background: rgba(0, 20, 0, 0.3);
            border: 1px solid #00ff88;
            border-radius: 2px;
            padding: 4px;
            margin-top: 5px;
            text-align: center;
        }

        .active-freq-label {
            font-size: 0.45rem;
            color: #888;
            text-transform: uppercase;
        }

        .active-freq-value {
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            color: #00ff88;
            font-weight: bold;
        }

        /* === NUEVOS ESTILOS PARA CANALES CB/PMR (MANTENIENDO DISEÑO ORIGINAL) === */
        .pmr-cb-section {
            margin-top: 5px;
            border: 1px solid #333;
            border-radius: 3px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.8);
        }

        .pmr-cb-title {
            font-size: 0.6rem;
            color: #00ff88;
            margin-bottom: 3px;
            text-align: center;
            border-bottom: 1px solid #333;
            padding-bottom: 3px;
        }

        .channel-type-selector {
            display: flex;
            gap: 2px;
            margin-bottom: 3px;
        }

        .channel-type-btn {
            flex: 1;
            padding: 3px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            color: #888;
            font-size: 0.5rem;
            cursor: pointer;
            text-align: center;
            border-radius: 2px;
            transition: all 0.2s;
        }

        .channel-type-btn:hover {
            border-color: #0088ff;
            color: #0088ff;
        }

        .channel-type-btn.active {
            background: rgba(0, 136, 255, 0.2);
            border-color: #0088ff;
            color: #0088ff;
        }

        .channel-container {
            display: none;
            margin-top: 3px;
        }

        .channel-container.active {
            display: block;
        }

        .channel-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            margin-top: 3px;
        }

        .channel-btn {
            padding: 3px 1px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            color: #00ff88;
            font-size: 0.5rem;
            cursor: pointer;
            text-align: center;
            border-radius: 1px;
            transition: all 0.2s;
        }

        .channel-btn:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
        }

        .channel-btn.active {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            color: #00ff88;
            box-shadow: 0 0 4px rgba(0, 255, 136, 0.3);
        }

        .channel-info {
            background: rgba(0, 20, 0, 0.3);
            border: 1px solid #00ff88;
            border-radius: 2px;
            padding: 3px;
            margin-top: 3px;
            text-align: center;
            font-size: 0.55rem;
        }

        .channel-display {
            font-family: 'Courier New', monospace;
            color: #00ff88;
            font-weight: bold;
        }

        /* === CONTENEDOR FONÉTICO MEJORADO (SCROLL ARREGLADO) === */
        .phonetic-table-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 3px;
            padding: 5px;
            overflow: hidden;
            min-height: 150px;
            max-height: 180px;
        }

        .phonetic-header {
            font-size: 0.65rem;
            color: #00ff88;
            margin-bottom: 5px;
            text-align: center;
            border-bottom: 1px solid #333;
            padding-bottom: 4px;
            flex-shrink: 0;
        }

        .phonetic-grid-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid rgba(0, 136, 255, 0.3);
            border-radius: 2px;
            background: rgba(5, 5, 5, 0.9);
        }

        .phonetic-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 3px;
            padding: 3px;
        }

        .phonetic-item {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            border-radius: 2px;
            padding: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 35px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .phonetic-item:hover {
            background: rgba(0, 136, 255, 0.2);
            border-color: #0088ff;
            transform: scale(1.05);
        }

        .phonetic-char {
            font-size: 0.85rem;
            color: #00ff88;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .phonetic-word {
            font-size: 0.65rem;
            color: #0088ff;
            margin-bottom: 2px;
            font-weight: bold;
        }

        .phonetic-pronunciation {
            font-size: 0.5rem;
            color: #ffaa00;
            font-style: italic;
        }

        /* === SCROLL ESTILIZADO PARA EL FONÉTICO === */
        .phonetic-grid-container::-webkit-scrollbar {
            width: 5px;
        }

        .phonetic-grid-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2px;
        }

        .phonetic-grid-container::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.7);
            border-radius: 2px;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .phonetic-grid-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 136, 0.9);
            box-shadow: 0 0 4px rgba(0, 255, 136, 0.5);
        }

        .emergency-frequencies {
            margin-top: 5px;
            border-top: 1px solid #333;
            padding-top: 3px;
            flex-shrink: 0;
        }

        .emergency-title {
            font-size: 0.5rem;
            color: #ff3300;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .emergency-list {
            font-size: 0.45rem;
            color: #ff6600;
            max-height: 60px;
            overflow-y: auto;
        }

        .emergency-item {
            padding: 1px 2px;
            border-bottom: 1px solid rgba(255, 51, 0, 0.1);
        }

        .emergency-item:hover {
            background: rgba(255, 51, 0, 0.1);
        }

        /* Transmisión activa */
        .transmission-active {
            animation: transmissionPulse 1s infinite;
        }

        @keyframes transmissionPulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Sonido de estática */
        .static-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 1px,
                rgba(255, 255, 255, 0.02) 1px,
                rgba(255, 255, 255, 0.02) 2px
            );
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .static-active {
            opacity: 0.3;
        }

        /* === ESTILOS PARA PESTAÑA SATÉLITE v4.5 === */
        .satellite-tab-content {
            padding: 5px;
            height: 100%;
            overflow-y: auto;
        }

        .satellite-tab-content::-webkit-scrollbar {
            width: 4px;
        }

        .satellite-tab-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2px;
        }

        .satellite-tab-content::-webkit-scrollbar-thumb {
            background: rgba(0, 136, 255, 0.5);
            border-radius: 2px;
        }

        .satellite-tab-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 136, 255, 0.7);
        }

        .sat-section {
            background: rgba(0, 10, 20, 0.7);
            border: 1px solid #0088ff;
            border-radius: 3px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .sat-section-header {
            background: linear-gradient(90deg, rgba(0, 20, 40, 0.9), rgba(0, 40, 80, 0.5));
            padding: 4px 8px;
            border-bottom: 1px solid #0088ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sat-section-title {
            font-size: 0.65rem;
            color: #00ffea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sat-section-icon {
            margin-right: 5px;
            color: #0088ff;
        }

        .sat-section-content {
            padding: 6px;
        }

        .sat-data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
            margin-bottom: 6px;
        }

        .sat-data-item {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 136, 255, 0.3);
            border-radius: 2px;
            padding: 4px;
        }

        .sat-data-label {
            font-size: 0.45rem;
            color: #88aaff;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .sat-data-value {
            font-size: 0.7rem;
            color: #00ffea;
            font-weight: bold;
        }

        .sat-gps-display {
            background: rgba(0, 10, 20, 0.8);
            border: 1px solid #00ffea;
            border-radius: 2px;
            padding: 5px;
            margin: 6px 0;
            text-align: center;
        }

        .sat-gps-coords {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #00ffea;
            margin: 3px 0;
        }

        .sat-controls {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }

        .sat-btn {
            flex: 1;
            padding: 4px;
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid #0088ff;
            color: #00ffea;
            font-size: 0.5rem;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
            text-align: center;
        }

        .sat-btn:hover {
            background: rgba(0, 40, 80, 0.8);
            transform: translateY(-1px);
        }

        .sat-btn.primary {
            background: linear-gradient(135deg, #0088ff, #00aaff);
            color: white;
            font-weight: bold;
        }

        .sat-alert-box {
            background: rgba(40, 0, 0, 0.7);
            border: 1px solid #ff3300;
            border-radius: 2px;
            padding: 5px;
            margin-top: 6px;
            font-size: 0.55rem;
            color: #ffaa00;
        }

        .sat-alert-title {
            font-weight: bold;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sat-status {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .sat-status-online {
            background: #00ff88;
            box-shadow: 0 0 4px #00ff88;
        }

        .sat-status-warning {
            background: #ffaa00;
            box-shadow: 0 0 4px #ffaa00;
            animation: pulseWarning 1s infinite;
        }

        .sat-emergency-section {
            border-color: #ff3300;
            margin-top: 10px;
        }

        .sat-emergency-header {
            background: linear-gradient(90deg, rgba(40, 0, 0, 0.9), rgba(80, 0, 0, 0.5));
            border-color: #ff3300;
        }

        .sat-emergency-btn {
            width: 100%;
            padding: 6px;
            background: linear-gradient(135deg, #ff3300, #ff6600);
            color: white;
            border: none;
            border-radius: 2px;
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            font-weight: bold;
            margin-top: 5px;
        }

        .sat-emergency-btn:hover {
            background: linear-gradient(135deg, #ff5500, #ff8800);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 51, 0, 0.3);
        }

        .sat-refresh-btn {
            background: none;
            border: none;
            color: #00ffea;
            cursor: pointer;
            font-size: 0.6rem;
            padding: 2px 5px;
        }

        .sat-refresh-btn:hover {
            color: #00ff88;
        }

        /* === NUEVOS ESTILOS PARA MICRÓFONO v4.7 === */
        .mic-btn {
            width: 36px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
            border: 1px solid #333;
            background: linear-gradient(135deg, #222 0, #333 100%);
            color: #ff4444;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .mic-btn:hover {
            border-color: #ff4444;
            box-shadow: 0 0 6px rgba(255, 68, 68, 0.5);
        }

        .mic-btn.listening {
            background: linear-gradient(135deg, #ff3300 0, #ff6600 100%);
            color: #000;
            border-color: #ffcc00;
            box-shadow: 0 0 12px rgba(255, 102, 0, 0.8);
        }

        #mic-status {
            font-size: 0.55rem;
            color: #888;
            min-width: 70px;
        }

        #mic-status.active {
            color: #ff6600;
        }

        /* === MEJORAS PARA EL INDICADOR DE VOZ v4.7 === */
        #mic-status.active {
            color: #ff6600;
            font-weight: bold;
            animation: voicePulse 1.5s infinite;
        }

        @keyframes voicePulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .mic-btn.listening {
            animation: micPulse 1s infinite;
        }

        @keyframes micPulse {
            0% { 
                box-shadow: 0 0 5px rgba(255, 68, 68, 0.5);
            }
            50% { 
                box-shadow: 0 0 15px rgba(255, 68, 68, 0.8);
            }
            100% { 
                box-shadow: 0 0 5px rgba(255, 68, 68, 0.5);
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header-pro">
            <div class="status-indicator">
                <span class="status-dot-live"></span>
                <span>RADCOM MASTER <span class="version-badge">v4.7</span></span>
                <span style="color:#888; margin-left:8px;">|</span>
                <span id="data-session" style="color:#00ffea">0</span>b
                <span class="security-badge">
                    <i class="fas fa-lock"></i>
                    ENCRYPTED
                </span>
            </div>
            <div id="display-id" style="font-size:0.6rem; color:#00ff88; font-family:monospace;">INICIANDO...</div>
            <div style="display:flex; gap:4px; align-items:center;">
                <!-- BOTÓN REFRESCAR PEQUEÑO COMO ANTES -->
                <button class="btn-header btn-refresh" onclick="refreshAllConnections()" title="Refrescar conexiones">
                    <i class="fas fa-sync-alt"></i>
                </button>
                
                <button class="btn-header" onclick="showSettings()" title="Configuración">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="btn-header" onclick="copyID()" title="Copiar ID">
                    <i class="fas fa-copy"></i>
                </button>
                <input type="text" id="peer-id-input" placeholder="ID Satélite" 
                       style="width:85px; background:rgba(0,0,0,0.8); color:#fff; 
                              border:1px solid #333; font-size:0.55rem; padding:2px 4px;
                              border-radius:2px; outline:none;">
                <button class="btn-header" style="background:#00ff88; color:#000; border:none; 
                        padding:2px 6px;" onclick="connectToPeer()">
                    <i class="fas fa-link"></i> LINK
                </button>
            </div>
        </div>

        <div class="main-layout">
            <div class="sidebar" id="peer-list">
                <div class="sidebar-section">
                    <div class="sidebar-title">
                        SISTEMA CEREBRO
                        <span class="encryption-indicator">
                            <i class="fas fa-shield-alt"></i> AES-256
                        </span>
                    </div>
                    <div id="target-global" class="peer-item active" onclick="selectPeer('GLOBAL')">
                        <div class="peer-info">
                            <span class="status-dot st-online"></span>
                            <div style="display:flex; flex-direction:column;">
                                <span style="font-weight:bold;">TRANSMISIÓN GLOBAL</span>
                                <span style="font-size:0.55rem; color:#888;">
                                    <span id="connected-count">0</span> satélites
                                </span>
                            </div>
                        </div>
                        <span style="color:#00ff88; font-size:0.55rem;">ACTIVO</span>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">
                        HISTORIAL AUTO-LINK
                        <span onclick="toggleShowOffline()" style="cursor:pointer; font-size:0.5rem; color:#888;" 
                              title="Mostrar/Ocultar offline">
                            <i class="fas fa-eye-slash"></i>
                        </span>
                        <span class="encryption-indicator">
                            <i class="fas fa-history"></i> LOCAL
                        </span>
                    </div>
                    <div id="saved-peers-container">
                        <div id="saved-peers"></div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">
                        ESTADÍSTICAS
                    </div>
                    <div style="padding:5px; font-size:0.55rem;">
                        <div style="margin-bottom:2px;">
                            <span style="color:#888;">Mensajes:</span>
                            <span id="stats-messages" style="color:#00ff88; float:right;">0</span>
                        </div>
                        <div style="margin-bottom:2px;">
                            <span style="color:#888;">Datos TX:</span>
                            <span id="stats-tx" style="color:#0088ff; float:right;">0 B</span>
                        </div>
                        <div style="margin-bottom:2px;">
                            <span style="color:#888;">Datos RX:</span>
                            <span id="stats-rx" style="color:#ff3300; float:right;">0 B</span>
                        </div>
                        <div>
                            <span style="color:#888;">Latencia:</span>
                            <span id="stats-latency" style="color:#00ff88; float:right;">-- ms</span>
                        </div>
                        
                        <!-- BOTÓN REVIVIR MEJORADO -->
                        <button class="revive-btn" onclick="reviveAllConnections()" title="Reactivar conexiones inactivas" id="reviveBtn">
                            <i class="fas fa-heartbeat"></i> REVIVIR CONEXIONES
                        </button>
                    </div>
                </div>
            </div>

            <div class="content-area">
                <div class="monitor-container" id="monitorContainer">
                    <div id="monitor-raw">SISTEMA INICIADO | ESCUCHANDO CONEXIONES...</div>
                    
                    <div class="resizable-separator" id="resizableSeparator"></div>
                    
                    <div class="table-container" id="tableContainer">
                        <div class="table-info">
                            <div class="char-preview">
                                <div class="preview-box">
                                    <div class="preview-label">CARÁCTER</div>
                                    <div id="current-char" class="preview-value">-</div>
                                </div>
                                <div class="preview-box">
                                    <div class="preview-label">HEX</div>
                                    <div id="current-hex" class="preview-value" style="color:#00ffea;">--</div>
                                </div>
                                <div class="preview-box">
                                    <div class="preview-label">DEC</div>
                                    <div id="current-dec" class="preview-value" style="color:#0088ff;">---</div>
                                </div>
                                <div class="preview-box">
                                    <div class="preview-label">BIN</div>
                                    <div id="current-bin" class="preview-value" style="color:#ff3300; font-size:0.6rem;">--------</div>
                                </div>
                                <div class="preview-box">
                                    <div class="preview-label">POSICIÓN</div>
                                    <div id="current-pos" class="preview-value" style="color:#00ff88;">V:-- H:--</div>
                                </div>
                            </div>
                            <button class="btn-header" onclick="clearTableSelection()" 
                                    style="font-size:0.45rem; padding:1px 3px;">
                                <i class="fas fa-times"></i> LIMPIAR
                            </button>
                        </div>
                        
                        <div class="tab-container">
                            <button class="tab-button active" data-tab="ascii" onclick="switchTab('ascii')">ASCII</button>
                            <button class="tab-button" data-tab="morse" onclick="switchTab('morse')">CQ Morse</button>
                            <button class="tab-button" data-tab="radio" onclick="switchTab('radio')">Radio</button>
                            <button class="tab-button" data-tab="satellite" onclick="switchTab('satellite')">Satélite</button>
                        </div>
                        
                        <div class="ansi-container">
                            <div id="ascii-table" class="tab-content active">
                                <table id="ansiTable"></table>
                            </div>
                            <div id="morse-table" class="tab-content">
                                <!-- Controles de sonido Morse -->
                                <div class="morse-controls">
                                    <div class="audio-status">
                                        <i class="fas fa-volume-up"></i>
                                        <span>SONIDO MORSE</span>
                                    </div>
                                    <div class="morse-speed-controls">
                                        <span style="color:#888; margin-right:2px;">VEL:</span>
                                        <button class="speed-btn active" onclick="setMorseSpeed('slow')">LENTA</button>
                                        <button class="speed-btn" onclick="setMorseSpeed('normal')">NORMAL</button>
                                        <button class="speed-btn" onclick="setMorseSpeed('fast')">RÁPIDA</button>
                                    </div>
                                    <button class="test-play-btn" onclick="playMorsePreview()">
                                        <i class="fas fa-play"></i> PROBAR
                                    </button>
                                </div>
                                
                                <!-- Tabla Morse mejorada -->
                                <div class="morse-table-container">
                                    <table id="morseTable"></table>
                                </div>
                            </div>
                            <div id="radio-table" class="tab-content">
                                <!-- SISTEMA DE RADIO v4.6 ORIGINAL MEJORADO -->
                                <div class="radio-container">
                                    <!-- Panel superior: Controles de frecuencia -->
                                    <div class="radio-controls">
                                        <!-- Entrada de frecuencia (izquierda) -->
                                        <div class="frequency-input-container">
                                            <div class="frequency-label">Frecuencia de Transmisión</div>
                                            <div class="frequency-display" id="radio-frequency-display">142.850 MHz</div>
                                            <div class="frequency-input-row">
                                                <input type="text" class="frequency-input" id="radio-frequency-input" 
                                                       value="142.850" placeholder="000.000">
                                                <select class="unit-selector" id="radio-unit">
                                                    <option value="MHz">MHz</option>
                                                    <option value="KHz">KHz</option>
                                                </select>
                                            </div>
                                            <div class="tune-buttons">
                                                <button class="tune-btn" onclick="tuneFrequency(-0.005)">-5KHz</button>
                                                <button class="tune-btn" onclick="tuneFrequency(-0.001)">-1KHz</button>
                                                <button class="tune-btn" onclick="tuneFrequency(0.001)">+1KHz</button>
                                                <button class="tune-btn" onclick="tuneFrequency(0.005)">+5KHz</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Selector de bandas (derecha) -->
                                        <div class="band-selector-container">
                                            <div class="frequency-label">Selector de Banda</div>
                                            <div class="band-buttons">
                                                <button class="band-btn" data-band="UHF" onclick="selectBand('UHF')">UHF</button>
                                                <button class="band-btn active" data-band="VHF" onclick="selectBand('VHF')">VHF</button>
                                                <button class="band-btn" data-band="AEREA" onclick="selectBand('AEREA')">AÉREA</button>
                                                <button class="band-btn" data-band="MARINA" onclick="selectBand('MARINA')">MARINA</button>
                                                <button class="band-btn" data-band="HF" onclick="selectBand('HF')">HF</button>
                                                <button class="band-btn" data-band="EMERG" onclick="selectBand('EMERG')">EMERG.</button>
                                            </div>
                                            
                                            <!-- Sub-bandas HF (solo visible cuando HF está seleccionado) -->
                                            <div id="hf-sub-bands" style="display: none;">
                                                <div style="font-size:0.45rem; color:#ffaa00; margin-bottom:2px;">Bandas HF:</div>
                                                <div class="hf-bands">
                                                    <button class="hf-band-btn" data-hf="10m" onclick="selectHFBand('10m')">10m</button>
                                                    <button class="hf-band-btn" data-hf="15m" onclick="selectHFBand('15m')">15m</button>
                                                    <button class="hf-band-btn" data-hf="20m" onclick="selectHFBand('20m')">20m</button>
                                                    <button class="hf-band-btn" data-hf="40m" onclick="selectHFBand('40m')">40m</button>
                                                    <button class="hf-band-btn" data-hf="80m" onclick="selectHFBand('80m')">80m</button>
                                                    <button class="hf-band-btn" data-hf="160m" onclick="selectHFBand('160m')">160m</button>
                                                    <button class="hf-band-btn" data-hf="320m" onclick="selectHFBand('320m')">320m</button>
                                                    <button class="hf-band-btn" data-hf="640m" onclick="selectHFBand('640m')">640m</button>
                                                </div>
                                            </div>
                                            
                                            <!-- NUEVA SECCIÓN: CB y PMR -->
                                            <div class="pmr-cb-section">
                                                <div class="pmr-cb-title">
                                                    <i class="fas fa-walkie-talkie"></i> CB & PMR446
                                                </div>
                                                <div class="channel-type-selector">
                                                    <button class="channel-type-btn active" onclick="selectChannelType('pmr')">PMR446</button>
                                                    <button class="channel-type-btn" onclick="selectChannelType('cb')">CB 27MHz</button>
                                                </div>
                                                
                                                <!-- Canales PMR -->
                                                <div id="pmr-container" class="channel-container active">
                                                    <div style="font-size:0.45rem; color:#888; margin-bottom:2px;">
                                                        Selecciona tipo:
                                                        <select id="pmr-type" style="margin-left:5px; font-size:0.4rem;" onchange="selectPMRType(this.value)">
                                                            <option value="8">8 Canales</option>
                                                            <option value="16">16 Canales</option>
                                                            <option value="32">32 Canales</option>
                                                        </select>
                                                    </div>
                                                    <div class="channel-grid" id="pmr-channels-grid">
                                                        <!-- Generado por JavaScript -->
                                                    </div>
                                                </div>
                                                
                                                <!-- Canales CB -->
                                                <div id="cb-container" class="channel-container">
                                                    <div class="channel-grid" id="cb-channels-grid">
                                                        <!-- Generado por JavaScript -->
                                                    </div>
                                                </div>
                                                
                                                <!-- Información del canal -->
                                                <div class="channel-info">
                                                    <div style="font-size:0.4rem; color:#888;">Canal Activo:</div>
                                                    <div class="channel-display" id="channel-display">VHF 142.850 MHz</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Frecuencia activa -->
                                            <div class="active-frequency-display">
                                                <div class="active-freq-label">Frecuencia Activa</div>
                                                <div class="active-freq-value" id="active-frequency">142.850 MHz VHF</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Alfabeto fonético interactivo MEJORADO -->
                                    <div class="phonetic-table-container">
                                        <div class="phonetic-header">
                                            <i class="fas fa-broadcast-tower"></i> ALFABETO FONÉTICO RADIO
                                        </div>
                                        <div class="phonetic-grid-container">
                                            <div class="phonetic-grid" id="phonetic-grid">
                                                <!-- Generado por JavaScript -->
                                            </div>
                                        </div>
                                        
                                        <!-- Frecuencias de emergencia -->
                                        <div class="emergency-frequencies">
                                            <div class="emergency-title">
                                                <i class="fas fa-exclamation-triangle"></i> FRECUENCIAS DE EMERGENCIA
                                            </div>
                                            <div class="emergency-list" id="emergency-list">
                                                <!-- Generado por JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Overlay de estática (efecto visual) -->
                                    <div class="static-overlay" id="static-overlay"></div>
                                </div>
                            </div>
                            <div id="satellite-table" class="tab-content">
                                <!-- ====== NUEVA PESTAÑA SATÉLITE ====== -->
                                <div class="satellite-tab-content">
                                    <!-- SECCIÓN 1: PARAPENTE -->
                                    <div class="sat-section">
                                        <div class="sat-section-header">
                                            <div class="sat-section-title">
                                                <i class="fas fa-parachute-box sat-section-icon"></i>
                                                PARAPENTE - DATOS DE VUELO
                                            </div>
                                            <button class="sat-refresh-btn" onclick="refreshParaglidingData()" title="Actualizar datos">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                        <div class="sat-section-content">
                                            <div class="sat-data-grid">
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Viento Actual</div>
                                                    <div class="sat-data-value" id="pg-wind">12 km/h NNO</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Ráfagas Máx</div>
                                                    <div class="sat-data-value" id="pg-gusts">18 km/h</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Temperatura</div>
                                                    <div class="sat-data-value" id="pg-temp">18°C</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Humedad</div>
                                                    <div class="sat-data-value" id="pg-humidity">65%</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Visibilidad</div>
                                                    <div class="sat-data-value" id="pg-visibility">15 km</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Presión</div>
                                                    <div class="sat-data-value" id="pg-pressure">1013 hPa</div>
                                                </div>
                                            </div>
                                            
                                            <div class="sat-gps-display">
                                                <div style="font-size:0.45rem; color:#88aaff; margin-bottom:2px;">POSICIÓN GPS</div>
                                                <div class="sat-gps-coords" id="pg-gps">42.2315° N, 2.0951° E</div>
                                                <div style="font-size:0.45rem; color:#88aaff;">ALTITUD: <span id="pg-altitude" style="color:#00ffea;">850 m</span></div>
                                            </div>
                                            
                                            <div class="sat-controls">
                                                <button class="sat-btn" onclick="getParaglidingWeather()">
                                                    <i class="fas fa-wind"></i> METEO
                                                </button>
                                                <button class="sat-btn" onclick="getParaglidingGPS()">
                                                    <i class="fas fa-map-marker-alt"></i> GPS
                                                </button>
                                                <button class="sat-btn" onclick="toggleParaglidingAlerts()">
                                                    <i class="fas fa-exclamation-circle"></i> ALERTAS
                                                </button>
                                            </div>
                                            
                                            <div class="sat-alert-box" id="pg-alerts" style="display:none;">
                                                <div class="sat-alert-title">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    ALERTAS OFICIALES
                                                </div>
                                                <div id="pg-alerts-content" style="font-size:0.5rem;">
                                                    • Sin alertas activas<br>
                                                    • Condiciones estables<br>
                                                    • Viento dentro de límites
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- SECCIÓN 2: VELERO 8M -->
                                    <div class="sat-section">
                                        <div class="sat-section-header">
                                            <div class="sat-section-title">
                                                <i class="fas fa-ship sat-section-icon"></i>
                                                VELERO 8M - NAVEGACIÓN
                                            </div>
                                            <button class="sat-refresh-btn" onclick="refreshSailingData()" title="Actualizar datos">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                        <div class="sat-section-content">
                                            <div class="sat-data-grid">
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Estado del Mar</div>
                                                    <div class="sat-data-value" id="sv-sea">1-2 (Floja)</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Viento</div>
                                                    <div class="sat-data-value" id="sv-wind">15 nudos ESE</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Altura Olas</div>
                                                    <div class="sat-data-value" id="sv-waves">1.2 m</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Período Olas</div>
                                                    <div class="sat-data-value" id="sv-period">8 s</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Corriente</div>
                                                    <div class="sat-data-value" id="sv-current">1.5 nudos → N</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Temp. Agua</div>
                                                    <div class="sat-data-value" id="sv-water-temp">19°C</div>
                                                </div>
                                            </div>
                                            
                                            <div class="sat-gps-display">
                                                <div style="font-size:0.45rem; color:#88aaff; margin-bottom:2px;">POSICIÓN Y RUMBO</div>
                                                <div class="sat-gps-coords" id="sv-gps">41.3851° N, 2.1734° E</div>
                                                <div style="font-size:0.45rem; color:#88aaff;">RUMBO: <span id="sv-heading" style="color:#00ffea;">245° SO</span></div>
                                            </div>
                                            
                                            <div class="sat-controls">
                                                <button class="sat-btn" onclick="getSailingWeather()">
                                                    <i class="fas fa-water"></i> MAR
                                                </button>
                                                <button class="sat-btn" onclick="getSailingGPS()">
                                                    <i class="fas fa-compass"></i> RUMBO
                                                </button>
                                                <button class="sat-btn" onclick="toggleSailingAlerts()">
                                                    <i class="fas fa-ship"></i> AVISOS
                                                </button>
                                            </div>
                                            
                                            <div class="sat-alert-box" id="sv-alerts" style="display:none;">
                                                <div class="sat-alert-title">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    AVISOS DE NAVEGACIÓN
                                                </div>
                                                <div id="sv-alerts-content" style="font-size:0.5rem;">
                                                    • Sin avisos de tormenta<br>
                                                    • Tráfico moderado en zona<br>
                                                    • Faros operativos
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- SECCIÓN 3: VIVAC -->
                                    <div class="sat-section">
                                        <div class="sat-section-header">
                                            <div class="sat-section-title">
                                                <i class="fas fa-hiking sat-section-icon"></i>
                                                VIVAC - RUTAS A PIE
                                            </div>
                                            <button class="sat-refresh-btn" onclick="refreshHikingData()" title="Actualizar datos">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                        <div class="sat-section-content">
                                            <div class="sat-data-grid">
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Condiciones</div>
                                                    <div class="sat-data-value" id="hv-conditions">BUENAS</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Temperatura</div>
                                                    <div class="sat-data-value" id="hv-temp">14°C</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Sensación Térmica</div>
                                                    <div class="sat-data-value" id="hv-feels-like">12°C</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Viento</div>
                                                    <div class="sat-data-value" id="hv-wind">8 km/h</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Humedad</div>
                                                    <div class="sat-data-value" id="hv-humidity">70%</div>
                                                </div>
                                                <div class="sat-data-item">
                                                    <div class="sat-data-label">Índice UV</div>
                                                    <div class="sat-data-value" id="hv-uv">5 (Moderado)</div>
                                                </div>
                                            </div>
                                            
                                            <div class="sat-gps-display">
                                                <div style="font-size:0.45rem; color:#88aaff; margin-bottom:2px;">POSICIÓN MONTAÑA</div>
                                                <div class="sat-gps-coords" id="hv-gps">42.6470° N, 1.0000° E</div>
                                                <div style="font-size:0.45rem; color:#88aaff;">ALTITUD: <span id="hv-altitude" style="color:#00ffea;">1450 m</span></div>
                                            </div>
                                            
                                            <div class="sat-controls">
                                                <button class="sat-btn" onclick="getHikingWeather()">
                                                    <i class="fas fa-mountain"></i> MONTAÑA
                                                </button>
                                                <button class="sat-btn" onclick="getHikingGPS()">
                                                    <i class="fas fa-map-marked-alt"></i> RUTA
                                                </button>
                                                <button class="sat-btn" onclick="toggleHikingAlerts()">
                                                    <i class="fas fa-campground"></i> ALERTAS
                                                </button>
                                            </div>
                                            
                                            <div class="sat-alert-box" id="hv-alerts" style="display:none;">
                                                <div class="sat-alert-title">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    ALERTAS DE MONTAÑA
                                                </div>
                                                <div id="hv-alerts-content" style="font-size:0.5rem;">
                                                    • Sin alertas por tormenta<br>
                                                    • Sendero en buen estado<br>
                                                    • Refugios operativos
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- SECCIÓN DE EMERGENCIA -->
                                    <div class="sat-section sat-emergency-section">
                                        <div class="sat-section-header sat-emergency-header">
                                            <div class="sat-section-title">
                                                <i class="fas fa-satellite-dish sat-section-icon"></i>
                                                EMERGENCIA SATELITAL
                                            </div>
                                            <span class="sat-status sat-status-online"></span>
                                        </div>
                                        <div class="sat-section-content">
                                            <div style="font-size:0.55rem; color:#ffaa00; margin-bottom:8px; text-align:center;">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                EN CASO DE EMERGENCIA, ESTE BOTÓN ENVIARÁ TU POSICIÓN GPS ACTUAL
                                            </div>
                                            
                                            <button class="sat-emergency-btn" onclick="sendSatelliteEmergency()">
                                                <i class="fas fa-satellite"></i> ENVIAR SEÑAL DE EMERGENCIA
                                            </button>
                                            
                                            <div style="font-size:0.45rem; color:#888; margin-top:6px; text-align:center;">
                                                Se incluirán coordenadas GPS automáticamente
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="monitor-decoded">
                    <div class="message-bubble message-system">
                        <i class="fas fa-satellite"></i> SISTEMA RADCOM MASTER v4.5 INICIADO
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-pro">
            <div class="input-controls">
                <select id="inputMode" title="Modo de entrada" onchange="validateInputMode(); switchTabFromMode()">
                    <option value="text">TEXTO → HEX</option>
                    <option value="hex">HEX → TEXTO</option>
                    <option value="binary">BINARIO</option>
                    <option value="morse">CQ MORSE</option>
                    <option value="phonetic">RADIO FONÉTICO</option>
                    <option value="satellite">SATÉLITE</option>
                </select>
                
                <select id="encryptionMode" title="Encriptación">
                    <option value="xor">XOR Simple</option>
                    <option value="aes" selected>AES-256</option>
                    <option value="none">Sin encriptación</option>
                </select>
                
                <div style="position:relative; flex:1;">
                    <input type="password" id="key" placeholder="CLAVE DE ENCRIPTACIÓN" 
                           style="width:100%; padding:4px 6px; font-size:0.65rem;"
                           onfocus="this.type='text'" 
                           onblur="if(this.value==='')this.type='password'">
                    <button onclick="generateKey()" 
                            style="position:absolute; right:4px; top:50%; transform:translateY(-50%);
                                   background:none; border:none; color:#888; cursor:pointer; font-size:0.65rem;">
                        <i class="fas fa-random"></i>
                    </button>
                </div>
                
                <span id="target-display" style="color:#00ff88; font-weight:bold; font-size:0.65rem; min-width:100px;">
                    <i class="fas fa-crosshairs"></i> DESTINO: GLOBAL
                </span>
            </div>
            
            <!-- MODIFICADO: CON MICRÓFONO MEJORADO -->
            <div style="display:flex; height:36px; align-items:center; padding:4px 5px; gap:4px; border-bottom:1px solid #222;">
                <!-- BOTÓN LIMPIAR -->
                <button class="clear-chat-btn" onclick="clearChat()" style="flex:0 0 auto; width:36px" title="Limpiar chat">
                    <i class="fas fa-trash"></i>
                </button>

                <!-- NUEVO: BOTÓN MICRÓFONO A LA IZQUIERDA -->
                <button id="micBtn" class="mic-btn" title="Dictar por voz" onclick="toggleVoiceInput()">
                    <i class="fas fa-microphone"></i>
                </button>

                <!-- Campo de texto -->
                <input type="text" id="inputMsg"
                    placeholder="INYECTAR DATOS SEGUROS..."
                    oninput="validateInput(); realTimePreview(); realTimeTableHighlight();"
                    onkeydown="if(event.key === 'Enter'){ handleSendMessage(event); }"
                    style="height:100%; flex:1;">

                <!-- Botón ENVIAR -->
                <button id="sendBtn" onclick="handleSendButtonClick()" style="height:100%">
                    <i class="fas fa-paper-plane"></i> ENVIAR
                </button>

                <!-- Estado voz -->
                <span id="mic-status">Voz OFF</span>
            </div>
            
            <div class="stats-panel">
                <div class="stat-item">
                    <div class="stat-value" id="stats-uptime">00:00:00</div>
                    <div class="stat-label">TIEMPO ACTIVO</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stats-connections">0</div>
                    <div class="stat-label">CONEXIONES</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stats-encrypted">100%</div>
                    <div class="stat-label">ENCRIPTADO</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stats-bandwidth">0 KB/s</div>
                    <div class="stat-label">ANCHO BANDA</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de configuración (sin cambios) -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <button class="modal-close" onclick="hideSettings()">&times;</button>
            <div class="modal-title">
                <i class="fas fa-cog"></i> CONFIGURACIÓN v4.5
            </div>
            
            <div style="margin-bottom:10px;">
                <label style="display:block; margin-bottom:4px; color:#00ff88; font-size:0.75rem;">
                    IDENTIFICADOR DEL SISTEMA
                </label>
                <input type="text" id="systemName" style="width:100%; padding:5px; background:#000; 
                       color:#00ff88; border:1px solid #333; border-radius:2px; font-size:0.75rem;" 
                       value="RADCOM-MASTER-v5">
            </div>
            
            <!-- NUEVA SECCIÓN: CONFIGURACIÓN DE IDENTIFICADOR -->
            <div id="idSettingsSection" style="margin-bottom: 15px; border: 1px solid #333; padding: 10px; border-radius: 3px;">
                <div style="color: #00ff88; font-size: 0.75rem; margin-bottom: 8px; display: flex; align-items: center; gap: 5px;">
                    <i class="fas fa-fingerprint"></i> CONFIGURACIÓN DE IDENTIFICADOR
                </div>
                
                <div style="margin-bottom: 8px;">
                    <label style="display: flex; align-items: center; color: #00ff88; font-size: 0.7rem; cursor: pointer;">
                        <input type="checkbox" id="useFixedId" style="margin-right: 6px;" 
                               onchange="toggleIdMode()">
                        Usar ID fijo personalizado
                    </label>
                    <div style="font-size: 0.6rem; color: #888; margin-left: 20px; margin-top: 2px;">
                        Recomendado para reconexiones estables
                    </div>
                </div>
                
                <div id="customIdContainer" style="margin-top: 8px;">
                    <label style="display: block; margin-bottom: 4px; color: #00ff88; font-size: 0.7rem;">
                        ID Personalizado:
                    </label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="customIdInput" 
                               style="flex: 1; padding: 5px; background: #000; color: #00ff88; 
                                      border: 1px solid #333; border-radius: 2px; font-size: 0.7rem;"
                               placeholder="Ej: RADCOM-MI-ESTACION">
                        <button onclick="generateCustomId()" 
                                style="background: #333; color: #00ff88; border: 1px solid #444; 
                                       padding: 5px 8px; border-radius: 2px; cursor: pointer; font-size: 0.65rem;">
                            <i class="fas fa-random"></i>
                        </button>
                    </div>
                    <div style="font-size: 0.6rem; color: #888; margin-top: 4px;">
                        Actual: <span id="currentIdDisplay" style="color: #00ffea;">Cargando...</span>
                    </div>
                </div>
                
                <div style="margin-top: 10px; display: flex; gap: 8px;">
                    <button onclick="applyIdSettings()" 
                            style="flex: 1; padding: 6px; background: #00ff88; color: #000; 
                                   border: none; border-radius: 2px; font-weight: bold; cursor: pointer; font-size: 0.7rem;">
                        <i class="fas fa-save"></i> APLICAR ID
                    </button>
                    <button onclick="resetIdSettings()" 
                            style="padding: 6px 10px; background: #333; color: #ff3300; 
                                   border: 1px solid #444; border-radius: 2px; cursor: pointer; font-size: 0.7rem;">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            </div>
            
            <div style="margin-bottom:10px;">
                <div style="color:#00ff88; font-size:0.75rem; margin-bottom:6px;">
                    <i class="fas fa-network-wired"></i> TIPO DE CONEXIÓN
                </div>
                <div class="connection-type-selector">
                    <div class="connection-type-btn active" id="btn-wifi" onclick="selectConnectionType('wifi')">
                        <div class="connection-icon">
                            <i class="fas fa-wifi"></i>
                        </div>
                        RED WiFi
                        <div class="connection-info">
                            Redes privadas
                        </div>
                    </div>
                    <div class="connection-type-btn" id="btn-mobile" onclick="selectConnectionType('mobile')">
                        <div class="connection-icon">
                            <i class="fas fa-satellite-dish"></i>
                        </div>
                        DATOS MÓVILES
                        <div class="connection-info">
                            4G/5G Global
                        </div>
                    </div>
                </div>
                <div id="connection-status" style="font-size:0.65rem; color:#00ffea; margin-top:5px; text-align:center;">
                    Estado: <span id="current-connection-type">WiFi</span>
                </div>
            </div>
            
            <div style="margin-bottom:10px;">
                <label style="display:block; margin-bottom:4px; color:#00ff88; font-size:0.75rem;">
                    <input type="checkbox" id="autoReconnect" checked style="margin-right:4px;">
                    Reconexión automática
                </label>
                <label style="display:block; margin-bottom:4px; color:#00ff88; font-size:0.75rem;">
                    <input type="checkbox" id="soundEnabled" checked style="margin-right:4px;">
                    Efectos de sonido
                </label>
                <label style="display:block; margin-bottom:4px; color:#00ff88; font-size:0.75rem;">
                    <input type="checkbox" id="saveHistory" checked style="margin-right:4px;">
                    Guardar historial
                </label>
                <label style="display:block; margin-bottom:4px; color:#00ff88; font-size:0.75rem;">
                    <input type="checkbox" id="fastRecovery" checked style="margin-right:4px;">
                    Recuperación rápida
                </label>
                <label style="display:block; margin-bottom:4px; color:#00ff88; font-size:0.75rem;">
                    <input type="checkbox" id="aggressiveRevive" checked style="margin-right:4px;">
                    Revivir agresivo
                </label>
            </div>
            
            <button onclick="saveSettings()" style="width:100%; padding:7px; background:#00ff88; 
                    color:#000; border:none; border-radius:2px; font-weight:bold; cursor:pointer;
                    font-size:0.8rem;">
                <i class="fas fa-save"></i> GUARDAR CONFIGURACIÓN
            </button>
        </div>
    </div>

    <script>
        // ====== VERSIÓN 4.7 - CON RECONOCIMIENTO DE VOZ MEJORADO ======
        const VERSION = "4.7";
        const SYSTEM_NAME = "RADCOM MASTER";
        
        const chars = [
            ["NUL","DLE","SPC","0","@","P","`","p"],
            ["SOH","DC1","!","1","A","Q","a","q"],
            ["STX","DC2","\"","2","B","R","b","r"],
            ["ETX","DC3","#","3","C","S","c","s"],
            ["EOT","DC4","$","4","D","T","d","t"],
            ["ENQ","NAK","%","5","E","U","e","u"],
            ["ACK","SYN","&","6","F","V","f","v"],
            ["BEL","ETB","'","7","G","W","g","w"],
            ["BS","CAN","(","8","H","X","h","x"],
            ["HT","EM",")","9","I","Y","i","y"],
            ["LF","SUB","*",":","J","Z","j","z"],
            ["VT","ESC","+",";","K","[","k","{"],
            ["FF","FS",",","<","L","\\","l","|"],
            ["CR","GS","-","=","M","]","m","}"],
            ["SO","RS",".",">","N","^","n","~"],
            ["SI","US","/","?","O","_","o","DEL"]
        ];

        const morseCodes = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.', 'G': '--.', 'H': '....',
            'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..', 'M': '--', 'N': '-.', 'O': '---', 'P': '.--.',
            'Q': '--.-', 'R': '.-.', 'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
            'Y': '-.--', 'Z': '--..',
            '0': '-----', '1': '.----', '2': '..---', '3': '...--', '4': '....-', '5': '.....',
            '6': '-....', '7': '--...', '8': '---..', '9': '----.',
            '.': '.-.-.-', ',': '--..--', '?': '..--..', '/': '-..-.', ' ': '/'
        };

        // ====== VARIABLES GLOBALES ======
        let peer = null;
        let myPeerId = null;
        let connections = {};
        let savedIds = JSON.parse(localStorage.getItem('radcom_peers_v4') || "[]");
        let activeTarget = 'GLOBAL';
        let stats = {
            messages: 0,
            tx: 0,
            rx: 0,
            startTime: Date.now()
        };
        let audioContext = null;
        let currentConnectionType = 'wifi';
        
        // ====== VARIABLES MEJORADAS ======
        let connectionHealth = {};
        let showOffline = false;
        let fastRecovery = true;
        let aggressiveRevive = true;
        let isBackground = false;
        let revivingInProgress = false;
        let currentTab = 'ascii';

        // ====== VARIABLES PARA MORSE ======
        let morseSpeed = 'normal';
        let morseAudioContext = null;
        let isPlayingMorse = false;

        // ====== VARIABLES PARA RECONOCIMIENTO DE VOZ v4.7 MEJORADO ======
        let recognition = null;
        let recognizing = false;

        // ====== COORDENADAS SATELITALES (API REAL) ======
        const SAT_COORDS = {
            paragliding: { lat: 42.2315, lon: 2.0951 },
            sailing: { lat: 41.3851, lon: 2.1734 },
            hiking: { lat: 42.6470, lon: 1.0000 }
        };

        let satellitePositions = {
            paragliding: { lat: 42.2315, lon: 2.0951, alt: 850 },
            sailing: { lat: 41.3851, lon: 2.1734, heading: 245 },
            hiking: { lat: 42.6470, lon: 1.0000, alt: 1450 }
        };

        // ====== SISTEMA DE ID FIJOS MEJORADO ======
        const ID_SYSTEM = {
            currentId: null,
            defaultPrefix: 'RADCOM-',
            useFixedId: true,
            fixedId: null
        };

        // ====== SISTEMA DE RADIO v4.5 (ORIGINAL MEJORADO) ======
        let currentBand = 'VHF';
        let currentFrequency = 142.850;
        let currentUnit = 'MHz';
        let currentHFBand = null;
        let currentChannelType = 'pmr'; // 'pmr' o 'cb'
        let currentPMRType = 8; // 8, 16, 32
        let currentChannel = 1; // Canal actual
        let radioAudioContext = null;

        // Definición de bandas y frecuencias
        const radioBands = {
            'UHF': { min: 300, max: 3000, unit: 'MHz', default: 433.000 },
            'VHF': { min: 30, max: 300, unit: 'MHz', default: 142.850 },
            'AEREA': { min: 108, max: 137, unit: 'MHz', default: 121.500 },
            'MARINA': { min: 156, max: 162, unit: 'MHz', default: 156.800 },
            'HF': { min: 3, max: 30, unit: 'MHz', default: 14.300 },
            'EMERG': { min: 0, max: 0, unit: 'MHz', default: 121.500 }
        };

        // Sub-bandas HF con descripciones
        const hfBands = {
            '10m': { range: '28.0-29.7 MHz', desc: 'Propagación diurna excelente' },
            '15m': { range: '21.0-21.45 MHz', desc: 'Banda DX internacional' },
            '20m': { range: '14.0-14.35 MHz', desc: 'Banda DX principal' },
            '40m': { range: '7.0-7.3 MHz', desc: 'Regional/noche' },
            '80m': { range: '3.5-4.0 MHz', desc: 'Local/noche' },
            '160m': { range: '1.8-2.0 MHz', desc: 'Local larga distancia' },
            '320m': { range: '0.9-1.0 MHz', desc: 'Experimental LF' },
            '640m': { range: '0.47-0.49 MHz', desc: 'Experimental VLF' }
        };

        // Canales PMR446
        const pmrChannels = {
            8: {
                1: 446.00625, 2: 446.01875, 3: 446.03125, 4: 446.04375,
                5: 446.05625, 6: 446.06875, 7: 446.08125, 8: 446.09375
            },
            16: {
                1: 446.00625, 2: 446.01875, 3: 446.03125, 4: 446.04375,
                5: 446.05625, 6: 446.06875, 7: 446.08125, 8: 446.09375,
                9: 446.10625, 10: 446.11875, 11: 446.13125, 12: 446.14375,
                13: 446.15625, 14: 446.16875, 15: 446.18125, 16: 446.19375
            },
            32: {
                1: 446.00625, 2: 446.009375, 3: 446.0125, 4: 446.015625,
                5: 446.01875, 6: 446.021875, 7: 446.025, 8: 446.028125,
                9: 446.03125, 10: 446.034375, 11: 446.0375, 12: 446.040625,
                13: 446.04375, 14: 446.046875, 15: 446.05, 16: 446.053125,
                17: 446.05625, 18: 446.059375, 19: 446.0625, 20: 446.065625,
                21: 446.06875, 22: 446.071875, 23: 446.075, 24: 446.078125,
                25: 446.08125, 26: 446.084375, 27: 446.0875, 28: 446.090625,
                29: 446.09375, 30: 446.096875, 31: 446.1, 32: 446.103125
            }
        };

        // Canales CB (40 canales)
        const cbChannels = {
            1: 26.965, 2: 26.975, 3: 26.985, 4: 27.005, 5: 27.015,
            6: 27.025, 7: 27.035, 8: 27.055, 9: 27.065, 10: 27.075,
            11: 27.085, 12: 27.105, 13: 27.115, 14: 27.125, 15: 27.135,
            16: 27.155, 17: 27.165, 18: 27.175, 19: 27.185, 20: 27.205,
            21: 27.215, 22: 27.225, 23: 27.255, 24: 27.235, 25: 27.245,
            26: 27.265, 27: 27.275, 28: 27.285, 29: 27.295, 30: 27.305,
            31: 27.315, 32: 27.325, 33: 27.335, 34: 27.345, 35: 27.355,
            36: 27.365, 37: 27.375, 38: 27.385, 39: 27.395, 40: 27.405
        };

        // Frecuencias de emergencia por banda
        const emergencyFrequencies = {
            'UHF': [
                { freq: '433.000', purpose: 'Emergencia general UHF' },
                { freq: '446.000', purpose: 'PMR446 Canal 1' }
            ],
            'VHF': [
                { freq: '146.520', purpose: 'Simplex nacional (EEUU)' },
                { freq: '145.500', purpose: 'Emergencia VHF' }
            ],
            'AEREA': [
                { freq: '121.500', purpose: 'Emergencia aeronáutica' },
                { freq: '123.100', purpose: 'Ayuda aeronáutica' }
            ],
            'MARINA': [
                { freq: '156.800', purpose: 'Canal 16 - Emergencia' },
                { freq: '156.300', purpose: 'Canal 6 - Auxilio' }
            ],
            'HF': [
                { freq: '14.300', purpose: 'Emergencia HF global' },
                { freq: '7.296', purpose: 'Red de emergencia' }
            ],
            'EMERG': [
                { freq: '121.500', purpose: 'Emergencia aeronáutica' },
                { freq: '156.800', purpose: 'Emergencia marítima' },
                { freq: '27.185', purpose: 'Canal 19 CB - Emergencia' }
            ]
        };

        // Alfabeto fonético completo
        const phoneticAlphabetFull = {
            'A': { word: 'ALFA', pronunciation: 'AL - FAH' },
            'B': { word: 'BRAVO', pronunciation: 'BRAH - VOH' },
            'C': { word: 'CHARLIE', pronunciation: 'CHAR - LEE' },
            'D': { word: 'DELTA', pronunciation: 'DELL - TAH' },
            'E': { word: 'ECHO', pronunciation: 'ECK - OH' },
            'F': { word: 'FOXTROT', pronunciation: 'FOKS - TROT' },
            'G': { word: 'GOLF', pronunciation: 'GOLF' },
            'H': { word: 'HOTEL', pronunciation: 'HOH - TEL' },
            'I': { word: 'INDIA', pronunciation: 'IN - DEE - AH' },
            'J': { word: 'JULIETT', pronunciation: 'JEW - LEE - ETT' },
            'K': { word: 'KILO', pronunciation: 'KEY - LOH' },
            'L': { word: 'LIMA', pronunciation: 'LEE - MAH' },
            'M': { word: 'MIKE', pronunciation: 'MIKE' },
            'N': { word: 'NOVEMBER', pronunciation: 'NO - VEM - BER' },
            'O': { word: 'OSCAR', pronunciation: 'OSS - CAH' },
            'P': { word: 'PAPA', pronunciation: 'PAH - PAH' },
            'Q': { word: 'QUEBEC', pronunciation: 'KEH - BECK' },
            'R': { word: 'ROMEO', pronunciation: 'ROW - ME - OH' },
            'S': { word: 'SIERRA', pronunciation: 'SEE - AIR - RAH' },
            'T': { word: 'TANGO', pronunciation: 'TANG - GO' },
            'U': { word: 'UNIFORM', pronunciation: 'YOU - NEE - FORM' },
            'V': { word: 'VICTOR', pronunciation: 'VIK - TAH' },
            'W': { word: 'WHISKEY', pronunciation: 'WISS - KEY' },
            'X': { word: 'X-RAY', pronunciation: 'ECKS - RAY' },
            'Y': { word: 'YANKEE', pronunciation: 'YANG - KEY' },
            'Z': { word: 'ZULU', pronunciation: 'ZOO - LOO' },
            '0': { word: 'ZERO', pronunciation: 'ZE-RO' },
            '1': { word: 'ONE', pronunciation: 'WUN' },
            '2': { word: 'TWO', pronunciation: 'TOO' },
            '3': { word: 'THREE', pronunciation: 'TREE' },
            '4': { word: 'FOUR', pronunciation: 'FOW-ER' },
            '5': { word: 'FIVE', pronunciation: 'FIFE' },
            '6': { word: 'SIX', pronunciation: 'SIX' },
            '7': { word: 'SEVEN', pronunciation: 'SEV-EN' },
            '8': { word: 'EIGHT', pronunciation: 'AIT' },
            '9': { word: 'NINE', pronunciation: 'NIN-ER' }
        };

        // ======== RECONOCIMIENTO DE VOZ v4.7 (CON ENVÍO AUTOMÁTICO) ========

        function initVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                updateMonitor("Reconocimiento de voz no soportado en este navegador.", "warning");
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.lang = "es-ES";
            recognition.continuous = false;
            recognition.interimResults = false; // Solo resultados finales
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                recognizing = true;
                const micBtn = document.getElementById("micBtn");
                const status = document.getElementById("mic-status");
                if (micBtn) micBtn.classList.add("listening");
                if (status) {
                    status.textContent = "ESCUCHANDO...";
                    status.classList.add("active");
                }
                updateMonitor("🎤 MODO VOZ ACTIVADO - HABLA AHORA", "info");
                playStrongBeep(800, 100);
            };

            recognition.onresult = (event) => {
                const input = document.getElementById("inputMsg");
                if (!input) return;
                
                const transcript = event.results[0][0].transcript.trim();
                
                if (transcript) {
                    // Mostrar el texto reconocido en el campo de entrada
                    input.value = transcript;
                    
                    // Actualizar vistas previas
                    validateInput();
                    realTimePreview();
                    realTimeTableHighlight();
                    
                    updateMonitor(`🎤 Reconocido: "${transcript.substring(0, 30)}${transcript.length > 30 ? '...' : ''}"`, "info");
                    playStrongBeep(600, 50);
                    
                    // ENVÍO AUTOMÁTICO DESPUÉS DE 1.5 SEGUNDOS
                    setTimeout(() => {
                        if (input.value.trim() && !recognizing) {
                            updateMonitor("⚡ ENVIANDO MENSAJE DE VOZ...", "info");
                            
                            // Pequeña pausa para mostrar el mensaje
                            setTimeout(() => {
                                const mode = document.getElementById('inputMode').value;
                                
                                // Verificar conexiones antes de enviar
                                const onlineCount = Object.keys(connections).filter(id => 
                                    connections[id]?.status === 'online').length;
                                
                                if (onlineCount === 0) {
                                    updateMonitor("⚠️ No hay conexiones activas para enviar", "warning");
                                    playStrongBeep(300, 200);
                                    return;
                                }
                                
                                // Enviar según el modo
                                if (mode === 'phonetic') {
                                    sendRadioMessage();
                                } else {
                                    sendMessage();
                                }
                                
                                // Restablecer el campo de entrada
                                input.value = "";
                                
                            }, 300);
                        }
                    }, 1500);
                }
            };

            recognition.onerror = (event) => {
                console.error("Error de reconocimiento de voz:", event.error);
                
                if (event.error === 'no-speech') {
                    updateMonitor("🎤 No se detectó voz. Intenta de nuevo.", "warning");
                } else if (event.error === 'audio-capture') {
                    updateMonitor("🎤 No se pudo acceder al micrófono.", "error");
                } else if (event.error === 'not-allowed') {
                    updateMonitor("🎤 Permiso de micrófono denegado.", "error");
                } else {
                    updateMonitor(`🎤 Error de voz: ${event.error}`, "error");
                }
                
                resetVoiceUI();
            };

            recognition.onend = () => {
                resetVoiceUI();
            };
        }

        // Función auxiliar para restablecer la UI de voz
        function resetVoiceUI() {
            recognizing = false;
            const micBtn = document.getElementById("micBtn");
            const status = document.getElementById("mic-status");
            if (micBtn) micBtn.classList.remove("listening");
            if (status) {
                status.textContent = "Voz OFF";
                status.classList.remove("active");
            }
        }

        function toggleVoiceInput() {
            // Si ya está activo, detenerlo
            if (recognizing) {
                try {
                    recognition.stop();
                    updateMonitor("🎤 Modo voz desactivado", "info");
                } catch(e) {
                    console.log("Reconocimiento ya detenido");
                }
                return;
            }
            
            // Inicializar si es necesario
            if (!recognition) {
                initVoiceRecognition();
                if (!recognition) {
                    updateMonitor("❌ No se pudo inicializar reconocimiento de voz", "error");
                    return;
                }
            }
            
            // Limpiar campo de entrada antes de empezar
            const input = document.getElementById("inputMsg");
            if (input) {
                input.value = "";
            }
            
            // Intentar iniciar el reconocimiento
            try {
                recognition.start();
            } catch(e) {
                console.error("Error al iniciar reconocimiento:", e);
                updateMonitor("❌ Error al acceder al micrófono. Verifica permisos.", "error");
                resetVoiceUI();
            }
        }

        // ====== FUNCIONES DE SISTEMA DE ID ======
        
        function generateHardwareBasedId() {
            const sources = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset(),
                localStorage.getItem('radcom_hardware_id')
            ];
            
            if (!localStorage.getItem('radcom_hardware_id')) {
                const hardwareId = 'HW-' + 
                    Math.random().toString(36).substring(2, 10) + 
                    '-' + 
                    Date.now().toString(36);
                localStorage.setItem('radcom_hardware_id', hardwareId);
                sources[4] = hardwareId;
            }
            
            let hash = 0;
            const str = sources.join('|');
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            return `RADCOM-${Math.abs(hash).toString(36).toUpperCase().substring(0, 8)}-V4`;
        }

        function generateRobustPeerId() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 8);
            return `RADCOM-${timestamp}-${random}`.toUpperCase();
        }

        function getOrCreateFixedId() {
            let fixedId = localStorage.getItem('radcom_fixed_id_v4');
            
            if (!fixedId) {
                fixedId = generateHardwareBasedId();
                localStorage.setItem('radcom_fixed_id_v4', fixedId);
            }
            
            return fixedId;
        }

        function initPeerJSEnhanced() {
            updateMonitor("📡 INICIALIZANDO SISTEMA DE ID FIJOS...");
            
            const config = JSON.parse(localStorage.getItem('radcom_config_v4') || '{}');
            ID_SYSTEM.useFixedId = config.useFixedId !== false;
            ID_SYSTEM.fixedId = config.fixedId || getOrCreateFixedId();
            
            let peerId;
            
            if (ID_SYSTEM.useFixedId && ID_SYSTEM.fixedId) {
                peerId = ID_SYSTEM.fixedId;
                updateMonitor(`🔧 USANDO ID FIJADO: ${peerId.substring(0, 20)}...`);
            } else {
                peerId = generateRobustPeerId();
                updateMonitor(`🎲 USANDO ID ALEATORIO: ${peerId.substring(0, 20)}...`);
            }
            
            ID_SYSTEM.currentId = peerId;
            localStorage.setItem('radcom_current_id', peerId);
            
            document.getElementById('currentIdDisplay').textContent = peerId;
            
            try {
                const iceConfig = {
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    },
                    debug: 0
                };
                
                if (currentConnectionType === 'mobile') {
                    iceConfig.config.iceServers = [
                        { urls: 'stun:global.stun.twilio.com:3478?transport=udp' },
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' }
                    ];
                }
                
                peer = new Peer(peerId, iceConfig);
                setupPeerEvents();
                updateMonitor(`✅ ID REGISTRADO: ${peerId.substring(0, 20)}...`);
                
            } catch (error) {
                console.error("Error inicializando PeerJS:", error);
                
                if (ID_SYSTEM.useFixedId) {
                    updateMonitor("⚠️ ID FIJADO OCUPADO. USANDO ID ALEATORIO...", "warning");
                    
                    peerId = generateRobustPeerId();
                    ID_SYSTEM.useFixedId = false;
                    ID_SYSTEM.fixedId = null;
                    
                    const config = JSON.parse(localStorage.getItem('radcom_config_v4') || '{}');
                    config.useFixedId = false;
                    config.fixedId = null;
                    localStorage.setItem('radcom_config_v4', JSON.stringify(config));
                    
                    setTimeout(() => {
                        if (peer) peer.destroy();
                        setTimeout(() => initPeerJSEnhanced(), 1000);
                    }, 500);
                }
            }
        }

        // ====== FUNCIONES BÁSICAS ======
        
        function buildAsciiTable() {
            const table = document.getElementById('ansiTable');
            let html = "<thead><tr><th class=\"row-idx\">V\\H</th>";
            
            for (let i = 0; i < 8; i++) {
                html += `<th>${i.toString(16).toUpperCase()}</th>`;
            }
            html += "</tr></thead><tbody>";
            
            for (let row = 0; row < 16; row++) {
                const rowHex = row.toString(16).toUpperCase();
                html += `<tr><td class="row-idx">${rowHex}</td>`;
                
                for (let col = 0; col < 8; col++) {
                    const displayChar = chars[row][col];
                    const asciiCode = (col << 4) | row;
                    const hexCode = asciiCode.toString(16).toUpperCase().padStart(2, '0');
                    
                    html += `<td data-row="${row}" data-col="${col}" data-ascii="${asciiCode}" 
                             data-hex="${hexCode}" data-char="${displayChar}" 
                             onclick="selectTableChar(this)"
                             title="${displayChar} | HEX: ${hexCode} | DEC: ${asciiCode}">
                             ${displayChar}
                             </td>`;
                }
                html += "</tr>";
            }
            
            html += "</tbody>";
            table.innerHTML = html;
        }

        function buildMorseTable() {
            const table = document.getElementById('morseTable');
            let html = "<thead><tr><th>CARÁCTER</th><th>CÓDIGO MORSE</th><th>EJEMPLO FONÉTICO</th><th>PROBAR</th></tr></thead><tbody>";
            
            for (let charCode = 65; charCode <= 90; charCode++) {
                const char = String.fromCharCode(charCode);
                const morse = morseCodes[char];
                const phonetic = phoneticAlphabetFull[char]?.word || char;
                
                html += `
                    <tr>
                        <td class="morse-char" onclick="selectMorseChar('${char}')">${char}</td>
                        <td class="morse-code" onclick="selectMorseCode('${morse}')">${morse}</td>
                        <td class="phonetic-example">${phonetic}</td>
                        <td>
                            <button class="play-morse-btn" onclick="playMorseCharSound('${char}')" 
                                    title="Probar sonido Morse para ${char}">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            for (let i = 0; i <= 9; i++) {
                const char = i.toString();
                const morse = morseCodes[char];
                const phonetic = phoneticAlphabetFull[char]?.word || char;
                
                html += `
                    <tr>
                        <td class="morse-char" onclick="selectMorseChar('${char}')">${char}</td>
                        <td class="morse-code" onclick="selectMorseCode('${morse}')">${morse}</td>
                        <td class="phonetic-example">${phonetic}</td>
                        <td>
                            <button class="play-morse-btn" onclick="playMorseCharSound('${char}')" 
                                    title="Probar sonido Morse para ${char}">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            const specialChars = ['.', ',', '?', '/', ' '];
            specialChars.forEach(char => {
                const morse = morseCodes[char];
                const displayChar = char === ' ' ? 'ESPACIO' : char;
                
                html += `
                    <tr>
                        <td class="morse-char" onclick="selectMorseChar('${char}')">${displayChar}</td>
                        <td class="morse-code" onclick="selectMorseCode('${morse}')">${morse}</td>
                        <td class="phonetic-example">---</td>
                        <td>
                            <button class="play-morse-btn" onclick="playMorseCharSound('${char}')" 
                                    title="Probar sonido Morse para ${displayChar}">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += "</tbody>";
            table.innerHTML = html;
        }

        function buildSatelliteTable() {
            // La tabla se construye directamente en el HTML
            console.log("🛰️ Tabla satelital construida");
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-button[data-tab="${tab}"]`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tab}-table`).classList.add('active');

            const modeSelect = document.getElementById('inputMode');
            if (tab === 'ascii') {
                if (modeSelect.value === 'morse' || modeSelect.value === 'phonetic' || modeSelect.value === 'satellite') {
                    modeSelect.value = 'text';
                }
            } else if (tab === 'morse') {
                modeSelect.value = 'morse';
            } else if (tab === 'radio') {
                modeSelect.value = 'phonetic';
                if (typeof initRadioSystem === 'function') {
                    setTimeout(initRadioSystem, 100);
                }
            } else if (tab === 'satellite') {
                modeSelect.value = 'satellite';
            }
            validateInputMode();
        }

        function switchTabFromMode() {
            const mode = document.getElementById('inputMode').value;
            if (mode === 'text' || mode === 'hex' || mode === 'binary') {
                switchTab('ascii');
            } else if (mode === 'morse') {
                switchTab('morse');
            } else if (mode === 'phonetic') {
                switchTab('radio');
            } else if (mode === 'satellite') {
                switchTab('satellite');
            }
        }

        function selectTableChar(cell) {
            document.querySelectorAll('#ansiTable td.selected').forEach(td => {
                td.classList.remove('selected');
            });
            
            cell.classList.add('selected');
            
            const row = parseInt(cell.getAttribute('data-row'));
            const col = parseInt(cell.getAttribute('data-col'));
            const asciiCode = parseInt(cell.getAttribute('data-ascii'));
            const hexCode = cell.getAttribute('data-hex');
            const displayChar = cell.getAttribute('data-char');
            
            updateCharPreview(row, col, asciiCode, hexCode, displayChar);
            
            const input = document.getElementById('inputMsg');
            const inputMode = document.getElementById('inputMode').value;
            
            if (displayChar === "SPC") {
                if (inputMode === 'hex') {
                    input.value += "20 ";
                } else if (inputMode === 'binary') {
                    input.value += "00100000 ";
                } else {
                    input.value += " ";
                }
            } else if (displayChar === "DEL") {
                if (inputMode === 'hex') {
                    input.value += "7F ";
                } else if (inputMode === 'binary') {
                    input.value += "01111111 ";
                } else {
                    input.value += "\x7F";
                }
            } else if (col <= 1) {
                if (inputMode === 'hex') {
                    input.value += hexCode + " ";
                } else if (inputMode === 'binary') {
                    const binary = asciiCode.toString(2).padStart(8, '0');
                    input.value += binary + " ";
                } else {
                    if (asciiCode === 9) input.value += "\t";
                    else if (asciiCode === 10) input.value += "\n";
                    else if (asciiCode === 13) input.value += "\r";
                    else if (asciiCode === 27) input.value += "\x1B";
                    else input.value += `[${displayChar}]`;
                }
            } else if (displayChar.length === 1) {
                if (inputMode === 'hex') {
                    input.value += hexCode + " ";
                } else if (inputMode === 'binary') {
                    const binary = asciiCode.toString(2).padStart(8, '0');
                    input.value += binary + " ";
                } else {
                    input.value += displayChar;
                }
            }
            
            input.focus();
            playStrongBeep(600, 50);
        }

        // ====== FUNCIONES DE MORSE ======
        
        function selectMorseChar(char) {
            const input = document.getElementById('inputMsg');
            const inputMode = document.getElementById('inputMode').value;
            
            input.value += char;
            input.focus();
            
            if (inputMode === 'morse' && document.getElementById('soundEnabled')?.checked) {
                playMorseCharSound(char);
            } else {
                playStrongBeep(600, 50);
            }
        }
        
        function selectMorseCode(code) {
            const input = document.getElementById('inputMsg');
            const inputMode = document.getElementById('inputMode').value;
            
            if (inputMode === 'morse') {
                input.value += code + ' ';
            } else {
                const char = getCharFromMorse(code);
                if (char) {
                    input.value += char;
                } else {
                    input.value += code;
                }
            }
            
            input.focus();
            
            if (inputMode === 'morse') {
                playMorseCodeSound(code);
            } else {
                playStrongBeep(600, 50);
            }
        }
        
        function getCharFromMorse(morseCode) {
            for (const [char, code] of Object.entries(morseCodes)) {
                if (code === morseCode) {
                    return char;
                }
            }
            return null;
        }
        
        function updateCharPreview(vertical, horizontal, ascii, hex, char) {
            document.getElementById('current-char').textContent = char;
            document.getElementById('current-hex').textContent = hex;
            document.getElementById('current-dec').textContent = ascii;
            document.getElementById('current-bin').textContent = ascii.toString(2).padStart(8, '0');
            document.getElementById('current-pos').textContent = 
                `V:${vertical.toString(16).toUpperCase()} H:${horizontal.toString(16).toUpperCase()}`;
        }

        function clearTableSelection() {
            document.querySelectorAll('#ansiTable td.selected').forEach(td => {
                td.classList.remove('selected');
            });
            
            document.getElementById('current-char').textContent = '-';
            document.getElementById('current-hex').textContent = '--';
            document.getElementById('current-dec').textContent = '---';
            document.getElementById('current-bin').textContent = '--------';
            document.getElementById('current-pos').textContent = 'V:-- H:--';
            
            document.querySelectorAll('#ansiTable td.highlighted').forEach(td => {
                td.classList.remove('highlighted');
            });
        }

        // ====== FUNCIONES DE SONIDO MORSE ======
        
        function initMorseAudio() {
            if (!morseAudioContext) {
                try {
                    morseAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (error) {
                    console.error("Error inicializando audio Morse:", error);
                }
            }
        }
        
        function playMorseCharSound(char) {
            if (isPlayingMorse) return;
            if (!document.getElementById('soundEnabled')?.checked) return;
            
            const morseCode = morseCodes[char];
            if (morseCode) {
                playMorseCodeSound(morseCode);
            }
        }
        
        function playMorseCodeSound(code) {
            if (!document.getElementById('soundEnabled')?.checked) return;
            
            initMorseAudio();
            if (!morseAudioContext || isPlayingMorse) return;
            
            isPlayingMorse = true;
            let time = morseAudioContext.currentTime;
            
            let dotDuration, dashDuration, symbolGap;
            
            switch (morseSpeed) {
                case 'slow':
                    dotDuration = 0.2;
                    dashDuration = 0.6;
                    symbolGap = 0.15;
                    break;
                case 'fast':
                    dotDuration = 0.1;
                    dashDuration = 0.3;
                    symbolGap = 0.08;
                    break;
                default:
                    dotDuration = 0.15;
                    dashDuration = 0.45;
                    symbolGap = 0.1;
            }
            
            for (let i = 0; i < code.length; i++) {
                const symbol = code[i];
                
                if (symbol === '.' || symbol === '-') {
                    const duration = symbol === '.' ? dotDuration : dashDuration;
                    
                    const oscillator = morseAudioContext.createOscillator();
                    const gainNode = morseAudioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(morseAudioContext.destination);
                    
                    oscillator.frequency.value = 700;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0, time);
                    gainNode.gain.linearRampToValueAtTime(0.3, time + 0.01);
                    gainNode.gain.setValueAtTime(0.3, time + duration - 0.01);
                    gainNode.gain.linearRampToValueAtTime(0, time + duration);
                    
                    oscillator.start(time);
                    oscillator.stop(time + duration);
                    
                    time += duration + symbolGap;
                }
            }
            
            setTimeout(() => {
                isPlayingMorse = false;
            }, (time - morseAudioContext.currentTime) * 1000 + 100);
        }
        
        function setMorseSpeed(speed) {
            morseSpeed = speed;
            
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.speed-btn[onclick="setMorseSpeed('${speed}')"]`).classList.add('active');
            
            updateMonitor(`⚡ Velocidad Morse: ${speed.toUpperCase()}`);
            playStrongBeep(800, 50);
        }
        
        function playMorsePreview() {
            const input = document.getElementById('inputMsg');
            const text = input.value.trim();
            
            if (!text) {
                updateMonitor("⚠️ Escribe algo para probar el sonido Morse", "warning");
                playStrongBeep(300, 100);
                return;
            }
            
            if (!document.getElementById('soundEnabled')?.checked) {
                updateMonitor("🔇 Sonido desactivado en configuración", "warning");
                return;
            }
            
            updateMonitor(`🔊 Probando Morse: "${text.substring(0, 20)}${text.length > 20 ? '...' : ''}"`);
            
            const words = text.toUpperCase().split(' ');
            
            let totalDelay = 0;
            words.forEach((word, wordIndex) => {
                for (let i = 0; i < word.length; i++) {
                    const char = word[i];
                    const morseCode = morseCodes[char];
                    
                    if (morseCode) {
                        setTimeout(() => {
                            playMorseCodeSound(morseCode);
                        }, totalDelay);
                        
                        const dotDuration = morseSpeed === 'slow' ? 200 : morseSpeed === 'fast' ? 100 : 150;
                        const dashDuration = morseSpeed === 'slow' ? 600 : morseSpeed === 'fast' ? 300 : 450;
                        const symbolGap = morseSpeed === 'slow' ? 150 : morseSpeed === 'fast' ? 80 : 100;
                        const letterGap = morseSpeed === 'slow' ? 400 : morseSpeed === 'fast' ? 200 : 300;
                        
                        let charDuration = 0;
                        for (let j = 0; j < morseCode.length; j++) {
                            if (morseCode[j] === '.') charDuration += dotDuration + symbolGap;
                            else if (morseCode[j] === '-') charDuration += dashDuration + symbolGap;
                        }
                        
                        totalDelay += charDuration + letterGap;
                    }
                }
                
                if (wordIndex < words.length - 1) {
                    totalDelay += morseSpeed === 'slow' ? 1200 : morseSpeed === 'fast' ? 600 : 900;
                }
            });
            
            playStrongBeep(1000, 100);
        }

        // ====== SISTEMA DE RADIO v4.5 ORIGINAL MEJORADO ======

        function buildRadioTable() {
            const grid = document.getElementById('phonetic-grid');
            let html = '';
            
            Object.keys(phoneticAlphabetFull).forEach(char => {
                const data = phoneticAlphabetFull[char];
                html += `
                    <div class="phonetic-item" onclick="selectPhoneticCharRadio('${char}')" 
                         title="${char}: ${data.word} (${data.pronunciation})">
                        <div class="phonetic-char">${char}</div>
                        <div class="phonetic-word">${data.word}</div>
                        <div class="phonetic-pronunciation">${data.pronunciation}</div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
            
            updateFrequencyDisplay();
            updateEmergencyFrequencies();
            buildPMRChannels();
            buildCBChannels();
            
            const freqInput = document.getElementById('radio-frequency-input');
            const unitSelect = document.getElementById('radio-unit');
            
            freqInput.addEventListener('input', validateFrequency);
            freqInput.addEventListener('change', updateFrequencyFromInput);
            unitSelect.addEventListener('change', updateUnit);
        }

        function validateFrequency() {
            const input = document.getElementById('radio-frequency-input');
            const value = input.value.replace(',', '.');
            
            if (!/^[\d.]*$/.test(value)) {
                input.value = value.replace(/[^\d.]/g, '');
            }
            
            const parts = value.split('.');
            if (parts.length > 1 && parts[1].length > 3) {
                input.value = parts[0] + '.' + parts[1].substring(0, 3);
            }
        }

        function updateFrequencyFromInput() {
            const input = document.getElementById('radio-frequency-input');
            let value = parseFloat(input.value.replace(',', '.'));
            
            if (isNaN(value)) {
                value = radioBands[currentBand].default;
                input.value = value.toFixed(3);
            }
            
            currentFrequency = value;
            updateFrequencyDisplay();
            updateChannelDisplay();
            playRadioBeep(800, 50);
        }

        function updateUnit() {
            const unitSelect = document.getElementById('radio-unit');
            currentUnit = unitSelect.value;
            
            if (currentUnit === 'KHz' && currentFrequency > 1000) {
                currentFrequency = currentFrequency / 1000;
            } else if (currentUnit === 'MHz' && currentFrequency < 1) {
                currentFrequency = currentFrequency * 1000;
            }
            
            updateFrequencyDisplay();
            updateChannelDisplay();
        }

        function tuneFrequency(step) {
            currentFrequency += step;
            
            const band = radioBands[currentBand];
            if (band) {
                if (currentFrequency < band.min) currentFrequency = band.min;
                if (currentFrequency > band.max) currentFrequency = band.max;
            }
            
            updateFrequencyDisplay();
            updateChannelDisplay();
            playRadioBeep(600 + Math.abs(step) * 100, 30);
            
            document.getElementById('radio-frequency-input').value = currentFrequency.toFixed(3);
        }

        function selectBand(band) {
            currentBand = band;
            currentHFBand = null;
            
            document.querySelectorAll('.band-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.band-btn[data-band="${band}"]`).classList.add('active');
            
            const hfContainer = document.getElementById('hf-sub-bands');
            if (band === 'HF') {
                hfContainer.style.display = 'block';
                selectHFBand('10m');
            } else {
                hfContainer.style.display = 'none';
                document.querySelectorAll('.hf-band-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
            
            if (radioBands[band]) {
                currentFrequency = radioBands[band].default;
                currentUnit = radioBands[band].unit;
                
                document.getElementById('radio-unit').value = currentUnit;
                document.getElementById('radio-frequency-input').value = currentFrequency.toFixed(3);
                
                updateFrequencyDisplay();
                updateEmergencyFrequencies();
                updateChannelDisplay();
                
                playBandChangeSound(band);
            }
        }

        function selectHFBand(hfBand) {
            currentHFBand = hfBand;
            
            document.querySelectorAll('.hf-band-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.hf-band-btn[data-hf="${hfBand}"]`).classList.add('active');
            
            if (hfBands[hfBand]) {
                const range = hfBands[hfBand].range.split('-')[0];
                const freq = parseFloat(range);
                if (!isNaN(freq)) {
                    currentFrequency = freq;
                    document.getElementById('radio-frequency-input').value = currentFrequency.toFixed(3);
                    updateFrequencyDisplay();
                    updateChannelDisplay();
                }
            }
            
            playRadioBeep(700, 40);
        }

        function selectChannelType(type) {
            currentChannelType = type;
            currentChannel = 1;
            
            document.querySelectorAll('.channel-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.channel-type-btn[onclick="selectChannelType('${type}')"]`).classList.add('active');
            
            document.querySelectorAll('.channel-container').forEach(container => {
                container.classList.remove('active');
            });
            document.getElementById(`${type}-container`).classList.add('active');
            
            if (type === 'pmr') {
                selectPMRChannel(1);
            } else if (type === 'cb') {
                selectCBChannel(19); // Canal 19 por defecto en CB
            }
            
            playRadioBeep(600, 40);
        }

        function buildPMRChannels() {
            const container = document.getElementById('pmr-channels-grid');
            container.innerHTML = '';
            
            const channels = pmrChannels[currentPMRType];
            for (let i = 1; i <= currentPMRType; i++) {
                const btn = document.createElement('button');
                btn.className = 'channel-btn';
                btn.textContent = i;
                btn.onclick = () => selectPMRChannel(i);
                container.appendChild(btn);
            }
            
            // Marcar primer canal como activo
            if (container.firstChild) {
                container.firstChild.classList.add('active');
            }
        }

        function selectPMRType(type) {
            currentPMRType = parseInt(type);
            buildPMRChannels();
            selectPMRChannel(1);
        }

        function selectPMRChannel(channel) {
            const channels = pmrChannels[currentPMRType];
            if (channels && channels[channel]) {
                currentFrequency = channels[channel];
                currentChannel = channel;
                
                document.querySelectorAll('#pmr-channels-grid .channel-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('#pmr-channels-grid .channel-btn')[channel - 1].classList.add('active');
                
                document.getElementById('radio-frequency-input').value = currentFrequency.toFixed(5);
                updateFrequencyDisplay();
                updateChannelDisplay();
                playRadioBeep(700, 40);
            }
        }

        function buildCBChannels() {
            const container = document.getElementById('cb-channels-grid');
            container.innerHTML = '';
            
            for (let i = 1; i <= 40; i++) {
                const btn = document.createElement('button');
                btn.className = 'channel-btn';
                btn.textContent = i;
                btn.onclick = () => selectCBChannel(i);
                container.appendChild(btn);
            }
            
            // Marcar canal 19 como activo por defecto
            if (container.children[18]) {
                container.children[18].classList.add('active');
            }
        }

        function selectCBChannel(channel) {
            if (cbChannels[channel]) {
                currentFrequency = cbChannels[channel];
                currentChannel = channel;
                
                document.querySelectorAll('#cb-channels-grid .channel-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('#cb-channels-grid .channel-btn')[channel - 1].classList.add('active');
                
                document.getElementById('radio-frequency-input').value = currentFrequency.toFixed(3);
                updateFrequencyDisplay();
                updateChannelDisplay();
                playRadioBeep(700, 40);
            }
        }

        function updateFrequencyDisplay() {
            const display = document.getElementById('radio-frequency-display');
            const activeDisplay = document.getElementById('active-frequency');
            
            let freqText = currentFrequency.toFixed(3);
            if (currentFrequency < 1 && currentUnit === 'MHz') {
                freqText = (currentFrequency * 1000).toFixed(1) + ' KHz';
            } else {
                freqText += ' ' + currentUnit;
            }
            
            display.textContent = freqText;
            
            let activeText = freqText + ' ' + currentBand;
            if (currentHFBand) {
                activeText += ' (' + currentHFBand + ')';
            }
            activeDisplay.textContent = activeText;
            
            localStorage.setItem('radcom_radio_freq', currentFrequency);
            localStorage.setItem('radcom_radio_band', currentBand);
            localStorage.setItem('radcom_radio_unit', currentUnit);
            if (currentHFBand) {
                localStorage.setItem('radcom_radio_hfband', currentHFBand);
            }
        }

        function updateChannelDisplay() {
            const display = document.getElementById('channel-display');
            
            if (currentChannelType === 'pmr') {
                display.textContent = `PMR446 CH${currentChannel} (${currentFrequency.toFixed(5)} MHz)`;
            } else if (currentChannelType === 'cb') {
                display.textContent = `CB CH${currentChannel} (${currentFrequency.toFixed(3)} MHz)`;
            } else {
                display.textContent = `${currentBand} ${currentFrequency.toFixed(3)} ${currentUnit}`;
            }
        }

        function updateEmergencyFrequencies() {
            const list = document.getElementById('emergency-list');
            const emergencies = emergencyFrequencies[currentBand] || [];
            
            let html = '';
            emergencies.forEach(emerg => {
                html += `
                    <div class="emergency-item" onclick="setEmergencyFrequency('${emerg.freq}')" 
                         title="${emerg.purpose}">
                        ${emerg.freq} MHz - ${emerg.purpose}
                    </div>
                `;
            });
            
            list.innerHTML = html || '<div class="emergency-item">No hay frecuencias de emergencia para esta banda</div>';
        }

        function setEmergencyFrequency(freq) {
            currentFrequency = parseFloat(freq);
            document.getElementById('radio-frequency-input').value = currentFrequency.toFixed(3);
            updateFrequencyDisplay();
            updateChannelDisplay();
            
            playEmergencyTone();
            updateMonitor(`⚠️ FRECUENCIA DE EMERGENCIA: ${freq} MHz`);
        }

        function selectPhoneticCharRadio(char) {
            const input = document.getElementById('inputMsg');
            const inputMode = document.getElementById('inputMode').value;
            const data = phoneticAlphabetFull[char];
            
            if (inputMode === 'phonetic') {
                input.value += data.word + ' ';
            } else {
                input.value += char;
            }
            
            input.focus();
            playPhoneticSound(char);
        }

        // ====== SONIDOS DE RADIO ======

        function initRadioAudio() {
            if (!radioAudioContext) {
                try {
                    radioAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (error) {
                    console.error("Error inicializando audio radio:", error);
                }
            }
        }

        function playRadioBeep(freq, duration) {
            if (!document.getElementById('soundEnabled')?.checked) return;
            
            initRadioAudio();
            if (!radioAudioContext) return;
            
            const oscillator = radioAudioContext.createOscillator();
            const gainNode = radioAudioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(radioAudioContext.destination);
            
            oscillator.frequency.value = freq;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, radioAudioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, radioAudioContext.currentTime + duration / 1000);
            
            oscillator.start(radioAudioContext.currentTime);
            oscillator.stop(radioAudioContext.currentTime + duration / 1000);
        }

        function playBandChangeSound(band) {
            if (!document.getElementById('soundEnabled')?.checked) return;
            
            initRadioAudio();
            if (!radioAudioContext) return;
            
            let time = radioAudioContext.currentTime;
            
            const freqs = {
                'UHF': [1200, 1400, 1600],
                'VHF': [800, 1000, 1200],
                'AEREA': [600, 800, 1000],
                'MARINA': [400, 600, 800],
                'HF': [200, 400, 600],
                'EMERG': [300, 150, 300]
            }[band] || [800, 1000, 1200];
            
            freqs.forEach((freq, index) => {
                const oscillator = radioAudioContext.createOscillator();
                const gainNode = radioAudioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(radioAudioContext.destination);
                
                oscillator.frequency.value = freq;
                oscillator.type = 'sawtooth';
                
                gainNode.gain.setValueAtTime(0.4, time);
                gainNode.gain.exponentialRampToValueAtTime(0.01, time + 0.1);
                
                oscillator.start(time);
                oscillator.stop(time + 0.1);
                
                time += 0.15;
            });
        }

        function playPhoneticSound(char) {
            if (!document.getElementById('soundEnabled')?.checked) return;
            
            playRadioBeep(500 + char.charCodeAt(0) * 10, 100);
        }

        function playEmergencyTone() {
            if (!document.getElementById('soundEnabled')?.checked) return;
            
            initRadioAudio();
            if (!radioAudioContext) return;
            
            let time = radioAudioContext.currentTime;
            
            for (let i = 0; i < 3; i++) {
                const oscillator = radioAudioContext.createOscillator();
                const gainNode = radioAudioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(radioAudioContext.destination);
                
                oscillator.frequency.value = i % 2 === 0 ? 1000 : 500;
                oscillator.type = 'sawtooth';
                
                gainNode.gain.setValueAtTime(0.5, time);
                gainNode.gain.exponentialRampToValueAtTime(0.01, time + 0.3);
                
                oscillator.start(time);
                oscillator.stop(time + 0.3);
                
                time += 0.35;
            }
        }

        function playTransmissionSound() {
            if (!document.getElementById('soundEnabled')?.checked) return;
            
            initRadioAudio();
            if (!radioAudioContext) return;
            
            const bufferSize = radioAudioContext.sampleRate * 0.5;
            const buffer = radioAudioContext.createBuffer(1, bufferSize, radioAudioContext.sampleRate);
            const output = buffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
                output[i] += 0.3 * Math.sin(2 * Math.PI * 1000 * i / radioAudioContext.sampleRate);
                const envelope = i < bufferSize * 0.1 ? i / (bufferSize * 0.1) : 
                                (bufferSize - i) / (bufferSize * 0.9);
                output[i] *= envelope;
            }
            
            const source = radioAudioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(radioAudioContext.destination);
            source.start();
            
            const staticOverlay = document.getElementById('static-overlay');
            staticOverlay.classList.add('static-active');
            
            setTimeout(() => {
                staticOverlay.classList.remove('static-active');
            }, 500);
        }

        // ====== INICIALIZACIÓN DE RADIO ======

        function initRadioSystem() {
            buildRadioTable();
            
            const savedFreq = localStorage.getItem('radcom_radio_freq');
            const savedBand = localStorage.getItem('radcom_radio_band');
            const savedUnit = localStorage.getItem('radcom_radio_unit');
            const savedHFBand = localStorage.getItem('radcom_radio_hfband');
            
            if (savedFreq) currentFrequency = parseFloat(savedFreq);
            if (savedBand) currentBand = savedBand;
            if (savedUnit) currentUnit = savedUnit;
            if (savedHFBand) currentHFBand = savedHFBand;
            
            document.querySelectorAll('.band-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const bandBtn = document.querySelector(`.band-btn[data-band="${currentBand}"]`);
            if (bandBtn) bandBtn.classList.add('active');
            
            document.getElementById('radio-frequency-input').value = currentFrequency.toFixed(3);
            document.getElementById('radio-unit').value = currentUnit;
            
            if (currentBand === 'HF' && currentHFBand) {
                document.getElementById('hf-sub-bands').style.display = 'block';
                const hfBtn = document.querySelector(`.hf-band-btn[data-hf="${currentHFBand}"]`);
                if (hfBtn) hfBtn.classList.add('active');
            }
            
            updateFrequencyDisplay();
            updateEmergencyFrequencies();
            updateChannelDisplay();
        }

        // ====== FUNCIONES DE ENVÍO ======

        function handleSendButtonClick() {
            const mode = document.getElementById('inputMode').value;
            if (mode === 'phonetic' && document.getElementById('radio-frequency-input')) {
                sendRadioMessage();
            } else {
                sendMessage();
            }
        }

        function handleSendMessage(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleSendButtonClick();
            }
        }

        // ====== FUNCIÓN DE ENVÍO DE RADIO ======

        function sendRadioMessage() {
            const input = document.getElementById('inputMsg');
            let message = input.value.trim();
            
            if (!message) {
                updateMonitor("⚠️ MENSAJE VACÍO", "error");
                playStrongBeep(300, 200);
                return;
            }
            
            const key = document.getElementById('key').value || 'ATOM80';
            const mode = document.getElementById('inputMode').value;
            const encryption = document.getElementById('encryptionMode').value;
            
            if (!validateInput()) {
                updateMonitor(`⚠️ FORMATO ${mode.toUpperCase()} INVÁLIDO`, "error");
                playStrongBeep(300, 200);
                return;
            }
            
            let processedMessage = message;
            
            // Si estamos en modo fonético y no es código fonético ya, convertirlo
            if (mode === 'phonetic') {
                processedMessage = textToPhonetic(message);
            }
            
            const dataToSend = prepareMessageToSend(processedMessage, mode, encryption, key);
            const sentCount = sendToConnections(dataToSend);
            
            if (sentCount > 0) {
                // Añadir información de radio al mensaje
                const freq = document.getElementById('radio-frequency-display').textContent;
                const band = currentBand;
                
                displayMessage(`📡 YO [${band} ${freq}]: ${message}`, 
                              dataToSend.hexPreview, 'outgoing');
                
                stats.tx += JSON.stringify(dataToSend).length;
                stats.messages++;
                input.value = '';
                updateMonitor(`📤 ENVIADO POR RADIO A ${sentCount} DESTINO${sentCount !== 1 ? 'S' : ''}`);
                updateStats();
                playTransmissionSound();
                
                if (activeTarget === 'GLOBAL') {
                    Object.keys(connections).forEach(peerId => {
                        if (connections[peerId]?.status === 'online') {
                            connectionHealth[peerId] = {
                                ...connectionHealth[peerId],
                                lastActivity: Date.now(),
                                packetsSent: (connectionHealth[peerId]?.packetsSent || 0) + 1
                            };
                        }
                    });
                } else if (connections[activeTarget]) {
                    connectionHealth[activeTarget] = {
                        ...connectionHealth[activeTarget],
                        lastActivity: Date.now(),
                        packetsSent: (connectionHealth[activeTarget]?.packetsSent || 0) + 1
                    };
                }
                
                document.querySelectorAll('#ansiTable td.highlighted').forEach(td => {
                    td.classList.remove('highlighted');
                });
            } else {
                updateMonitor("⚠️ SIN DESTINOS CONECTADOS", "warning");
                playStrongBeep(300, 200);
            }
        }

        // ====== FUNCIONES SATELITALES CON API REAL ======

        async function safeFetchJSON(url, description) {
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    updateMonitor("Error API " + description + ": " + res.status, "warning");
                    return null;
                }
                return await res.json();
            } catch (e) {
                updateMonitor("Error conexión API " + description, "error");
                return null;
            }
        }

        async function refreshParaglidingData() {
            updateMonitor("🌤️ Actualizando datos de parapente (API real)...", "info");

            const { lat, lon } = SAT_COORDS.paragliding;
            const url =
                "https://api.open-meteo.com/v1/forecast" +
                "?latitude=" + lat +
                "&longitude=" + lon +
                "&hourly=temperature_2m,apparent_temperature,wind_speed_10m,wind_direction_10m,relative_humidity_2m,uv_index" +
                "&current_weather=true&timezone=auto";

            const data = await safeFetchJSON(url, "parapente");
            if (!data) return;

            const cw = data.current_weather;
            const temp = cw ? cw.temperature : 18;
            const wind = cw ? cw.windspeed : 12;

            document.getElementById("pg-temp").textContent = temp.toFixed(1) + "°C";
            document.getElementById("pg-wind").textContent = wind.toFixed(0) + " km/h";
            document.getElementById("pg-conditions").textContent = "Tiempo real";
            document.getElementById("pg-gps").textContent = lat.toFixed(4) + " N, " + lon.toFixed(4) + " E";
        }

        function getParaglidingWeather() {
            refreshParaglidingData();
        }

        function getParaglidingGPS() {
            const { lat, lon } = SAT_COORDS.paragliding;
            document.getElementById("pg-gps").textContent = lat.toFixed(4) + " N, " + lon.toFixed(4) + " E";
        }

        function toggleParaglidingAlerts() {
            const alertsBox = document.getElementById('pg-alerts');
            const isVisible = alertsBox.style.display !== 'none';
            alertsBox.style.display = isVisible ? 'none' : 'block';
            playStrongBeep(600, 40);
        }

        async function refreshSailingData() {
            updateMonitor("🌊 Actualizando datos de navegación (API mar)...", "info");

            const { lat, lon } = SAT_COORDS.sailing;
            const url =
                "https://marine-api.open-meteo.com/v1/marine" +
                "?latitude=" + lat +
                "&longitude=" + lon +
                "&hourly=wave_height,wind_wave_height,wind_speed_10m,wind_direction_10m,water_temperature" +
                "&timezone=auto";

            const data = await safeFetchJSON(url, "mar");
            if (!data || !data.hourly) return;

            const i = 0;
            const h = data.hourly;

            const sea = (h.wave_height && h.wave_height[i]) || 1.0;
            const wind = (h.wind_speed_10m && h.wind_speed_10m[i]) || 15;
            const waterTemp = (h.water_temperature && h.water_temperature[i]) || 19;

            document.getElementById("sv-sea").textContent = sea.toFixed(1) + " m";
            document.getElementById("sv-wind").textContent = wind.toFixed(0) + " nudos";
            document.getElementById("sv-water-temp").textContent = waterTemp.toFixed(1) + "°C";
            document.getElementById("sv-gps").textContent = lat.toFixed(4) + " N, " + lon.toFixed(4) + " E";
        }

        function getSailingWeather() {
            refreshSailingData();
        }

        function getSailingGPS() {
            const { lat, lon } = SAT_COORDS.sailing;
            document.getElementById("sv-gps").textContent = lat.toFixed(4) + " N, " + lon.toFixed(4) + " E";
        }

        function getHeadingDirection(heading) {
            if (heading >= 337.5 || heading < 22.5) return 'N';
            if (heading >= 22.5 && heading < 67.5) return 'NE';
            if (heading >= 67.5 && heading < 112.5) return 'E';
            if (heading >= 112.5 && heading < 157.5) return 'SE';
            if (heading >= 157.5 && heading < 202.5) return 'S';
            if (heading >= 202.5 && heading < 247.5) return 'SO';
            if (heading >= 247.5 && heading < 292.5) return 'O';
            return 'NO';
        }

        function toggleSailingAlerts() {
            const alertsBox = document.getElementById('sv-alerts');
            const isVisible = alertsBox.style.display !== 'none';
            alertsBox.style.display = isVisible ? 'none' : 'block';
            playStrongBeep(550, 35);
        }

        async function refreshHikingData() {
            updateMonitor("⛰️ Actualizando datos de montaña (API real)...", "info");

            const { lat, lon } = SAT_COORDS.hiking;
            const url =
                "https://api.open-meteo.com/v1/forecast" +
                "?latitude=" + lat +
                "&longitude=" + lon +
                "&hourly=temperature_2m,apparent_temperature,wind_speed_10m,relative_humidity_2m,uv_index" +
                "&current_weather=true&timezone=auto";

            const data = await safeFetchJSON(url, "montaña");
            if (!data) return;

            const cw = data.current_weather;
            const temp = cw ? cw.temperature : 14;
            const wind = cw ? cw.windspeed : 8;

            document.getElementById("hv-temp").textContent = temp.toFixed(1) + "°C";
            document.getElementById("hv-wind").textContent = wind.toFixed(0) + " km/h";
            document.getElementById("hv-conditions").textContent = "Tiempo real";
            document.getElementById("hv-gps").textContent = lat.toFixed(4) + " N, " + lon.toFixed(4) + " E";
        }

        function getHikingWeather() {
            refreshHikingData();
        }

        function getHikingGPS() {
            const { lat, lon } = SAT_COORDS.hiking;
            document.getElementById("hv-gps").textContent = lat.toFixed(4) + " N, " + lon.toFixed(4) + " E";
        }

        function toggleHikingAlerts() {
            const alertsBox = document.getElementById('hv-alerts');
            const isVisible = alertsBox.style.display !== 'none';
            alertsBox.style.display = isVisible ? 'none' : 'block';
            playStrongBeep(600, 45);
        }

        function sendSatelliteEmergency() {
            if (!confirm("¿ENVIAR SEÑAL DE EMERGENCIA SATELITAL?\n\nSe enviará tu posición GPS actual a todos los contactos.")) {
                return;
            }
            
            updateMonitor("🚨 ENVIANDO SEÑAL DE EMERGENCIA SATELITAL...");
            playEmergencySatelliteTone();
            
            // Usar posición de parapente como ejemplo
            const emergencyPosition = satellitePositions.paragliding;
            
            // Crear mensaje de emergencia
            const emergencyMessage = `🚨 EMERGENCIA SATELITAL 🚨
Posición: ${emergencyPosition.lat.toFixed(4)}° N, ${emergencyPosition.lon.toFixed(4)}° E
Altitud: ${Math.round(emergencyPosition.alt)} m
Hora: ${new Date().toLocaleTimeString()}
Mensaje automático del Sistema RADCOM v4.6`;
            
            // Enviar a través del sistema existente
            const input = document.getElementById('inputMsg');
            input.value = emergencyMessage;
            
            // Cambiar automáticamente a modo satélite
            document.getElementById('inputMode').value = 'satellite';
            validateInputMode();
            
            // Enviar automáticamente después de 2 segundos
            setTimeout(() => {
                sendMessage();
                updateMonitor("✅ SEÑAL DE EMERGENCIA ENVIADA VÍA SATÉLITE");
                
                // Mostrar confirmación
                alert("✅ SEÑAL DE EMERGENCIA ENVIADA\n\nTu posición GPS ha sido transmitida a todos los contactos.\n\nCoordenadas: " + 
                      emergencyPosition.lat.toFixed(4) + "° N, " + emergencyPosition.lon.toFixed(4) + "° E\n" +
                      "Altitud: " + Math.round(emergencyPosition.alt) + " m");
            }, 2000);
        }

        function playEmergencySatelliteTone() {
            if (!document.getElementById('soundEnabled')?.checked) return;
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            let time = audioContext.currentTime;
            
            // Triple tono de emergencia
            for (let i = 0; i < 3; i++) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 1000;
                oscillator.type = 'sawtooth';
                
                gainNode.gain.setValueAtTime(0.5, time);
                gainNode.gain.exponentialRampToValueAtTime(0.01, time + 0.3);
                
                oscillator.start(time);
                oscillator.stop(time + 0.3);
                
                time += 0.4;
            }
        }

        // ====== FUNCIONES DE ENVÍO ORIGINALES ======

        function sendMessage() {
            const input = document.getElementById('inputMsg');
            let message = input.value.trim();
            
            if (!message) {
                updateMonitor("⚠️ MENSAJE VACÍO", "error");
                playStrongBeep(300, 200);
                return;
            }
            
            const key = document.getElementById('key').value || 'ATOM80';
            const mode = document.getElementById('inputMode').value;
            const encryption = document.getElementById('encryptionMode').value;
            
            // Si estamos en modo satélite, añadir automáticamente la posición GPS
            if (mode === 'satellite' && !message.includes('🚨 EMERGENCIA SATELITAL')) {
                const pos = satellitePositions.paragliding;
                const gpsInfo = `\n\n[GPS: ${pos.lat.toFixed(4)}° N, ${pos.lon.toFixed(4)}° E | Alt: ${Math.round(pos.alt)} m]`;
                message += gpsInfo;
            }
            
            if (!validateInput()) {
                updateMonitor(`⚠️ FORMATO ${mode.toUpperCase()} INVÁLIDO`, "error");
                playStrongBeep(300, 200);
                return;
            }
            
            let processedMessage = message;
            
            if (mode === 'morse') {
                if (!isMorseCode(message)) {
                    processedMessage = textToMorse(message);
                }
            } else if (mode === 'phonetic') {
                processedMessage = textToPhonetic(message);
            }
            
            const dataToSend = prepareMessageToSend(processedMessage, mode, encryption, key);
            const sentCount = sendToConnections(dataToSend);
            
            if (sentCount > 0) {
                displayMessage(`YO: ${message}`, dataToSend.hexPreview, 'outgoing');
                stats.tx += JSON.stringify(dataToSend).length;
                stats.messages++;
                input.value = '';
                updateMonitor(`📤 ENVIADO A ${sentCount} DESTINO${sentCount !== 1 ? 'S' : ''}`);
                updateStats();
                playStrongBeep(700, 100);
                
                if (activeTarget === 'GLOBAL') {
                    Object.keys(connections).forEach(peerId => {
                        if (connections[peerId]?.status === 'online') {
                            connectionHealth[peerId] = {
                                ...connectionHealth[peerId],
                                lastActivity: Date.now(),
                                packetsSent: (connectionHealth[peerId]?.packetsSent || 0) + 1
                            };
                        }
                    });
                } else if (connections[activeTarget]) {
                    connectionHealth[activeTarget] = {
                        ...connectionHealth[activeTarget],
                        lastActivity: Date.now(),
                        packetsSent: (connectionHealth[activeTarget]?.packetsSent || 0) + 1
                    };
                }
                
                document.querySelectorAll('#ansiTable td.highlighted').forEach(td => {
                    td.classList.remove('highlighted');
                });
            } else {
                updateMonitor("⚠️ SIN DESTINOS CONECTADOS", "warning");
                playStrongBeep(300, 200);
            }
        }

        function isMorseCode(text) {
            const morseRegex = /^[\.\-\s\/]+$/;
            return morseRegex.test(text);
        }

        function textToMorse(text) {
            return text.toUpperCase().split('').map(char => morseCodes[char] || char).join(' ');
        }

        function textToPhonetic(text) {
            return text.toUpperCase().split('').map(char => phoneticAlphabetFull[char]?.word || char).join(' ');
        }

        function prepareMessageToSend(message, mode, encryption, key) {
            let processedMessage = message;
            let hexPreview = '';
            
            if (mode === 'hex') {
                const hex = message.replace(/\s/g, '');
                if (hex.length % 2 !== 0) {
                    throw new Error('HEX debe tener longitud par');
                }
                processedMessage = '';
                for (let i = 0; i < hex.length; i += 2) {
                    processedMessage += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
                }
            } else if (mode === 'binary') {
                const binary = message.replace(/\s/g, '');
                if (binary.length % 8 !== 0) {
                    throw new Error('Binario debe ser múltiplo de 8');
                }
                processedMessage = '';
                for (let i = 0; i < binary.length; i += 8) {
                    processedMessage += String.fromCharCode(parseInt(binary.substr(i, 8), 2));
                }
            }
            
            let encryptedMessage = processedMessage;
            if (encryption === 'xor' || encryption === 'aes') {
                encryptedMessage = xorEncrypt(processedMessage, key);
                
                for (let i = 0; i < Math.min(encryptedMessage.length, 3); i++) {
                    hexPreview += encryptedMessage.charCodeAt(i).toString(16).padStart(2, '0');
                }
                if (encryptedMessage.length > 3) hexPreview += '...';
            }
            
            return {
                type: 'message',
                message: encryptedMessage,
                original: message,
                mode: mode,
                encryption: encryption,
                timestamp: Date.now(),
                sender: myPeerId,
                hexPreview: hexPreview
            };
        }

        function xorEncrypt(text, key) {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i);
                const keyCode = key.charCodeAt(i % key.length);
                result += String.fromCharCode(charCode ^ keyCode);
            }
            return result;
        }

        function xorDecrypt(text, key) {
            return xorEncrypt(text, key);
        }

        function sendToConnections(data) {
            let sentCount = 0;
            
            console.log("📤 Enviando datos:", data);
            
            if (activeTarget === 'GLOBAL') {
                Object.keys(connections).forEach(peerId => {
                    if (connections[peerId]?.status === 'online') {
                        try {
                            console.log(`📤 Enviando a ${peerId}`);
                            connections[peerId].conn.send(data);
                            sentCount++;
                        } catch (error) {
                            console.error(`❌ Error enviando a ${peerId}:`, error);
                        }
                    }
                });
            } else if (connections[activeTarget]?.status === 'online') {
                try {
                    console.log(`📤 Enviando a ${activeTarget}`);
                    connections[activeTarget].conn.send(data);
                    sentCount = 1;
                } catch (error) {
                    console.error(`❌ Error enviando a ${activeTarget}:`, error);
                }
            }
            
            console.log(`✅ Enviado a ${sentCount} destino(s)`);
            return sentCount;
        }

        // ====== FUNCIONES DE CONEXIÓN ======

        function setupPeerEvents() {
            peer.on('open', (id) => {
                myPeerId = id;
                localStorage.setItem('radcom_master_id_v4', id);
                
                document.getElementById('display-id').innerHTML = 
                    `<span style="color:#00ff88">ID: ${id.substring(0, 10)}...</span>`;
                
                const typeName = currentConnectionType === 'wifi' ? 'WiFi' : 'Datos Móviles';
                updateMonitor(`✅ SISTEMA v${VERSION} INICIADO | ${typeName} | ID: ${id.substring(0, 8)}`);
                
                savedIds.forEach(peerId => {
                    if (peerId !== id) {
                        setTimeout(() => connectToPeerId(peerId), 100);
                    }
                });
                
                setInterval(updateUptime, 1000);
                updateStats();
            });
            
            peer.on('connection', (conn) => {
                console.log("📞 Conexión entrante de:", conn.peer);
                handleIncomingConnection(conn);
            });
            
            peer.on('error', (err) => {
                console.error("PeerJS Error:", err);
                updateMonitor(`⚠️ ERROR: ${err.type}`, "error");
            });
        }

        function setupConnection(conn, type) {
            const peerId = conn.peer;
            
            connections[peerId] = {
                conn: conn,
                status: 'connecting',
                type: type,
                health: 'new',
                latency: 0,
                lastCheck: Date.now()
            };
            
            connectionHealth[peerId] = {
                connectedAt: Date.now(),
                lastActivity: Date.now(),
                packetsSent: 0,
                packetsReceived: 0
            };
            
            updatePeerList();
            
            conn.on('open', () => {
                console.log(`✅ Conexión establecida con:`, peerId);
                connections[peerId].status = 'online';
                connections[peerId].health = 'healthy';
                updatePeerList();
                updateConnectedCount();
                updateMonitor(`✅ CONECTADO A ${peerId.substring(0, 8)}`);
                playStrongBeep(800, 100);
                
                saveId(peerId);
                
                setTimeout(() => sendHealthPing(peerId), 1000);
            });
            
            conn.on('data', (data) => {
                console.log("📥 Datos recibidos de", peerId, ":", data);
                
                connectionHealth[peerId].lastActivity = Date.now();
                connectionHealth[peerId].packetsReceived++;
                
                if (data.type === 'health_ping') {
                    try {
                        conn.send({
                            type: 'health_pong',
                            timestamp: data.timestamp,
                            sender: myPeerId
                        });
                        console.log(`📡 Pong enviado a ${peerId}`);
                        return;
                    } catch (error) {
                        console.error(`❌ Error enviando pong:`, error);
                    }
                }
                
                if (data.type === 'health_pong') {
                    handleHealthPong(peerId, data.timestamp);
                    return;
                }
                
                try {
                    handleReceivedData(peerId, data);
                } catch (error) {
                    console.error("❌ Error procesando datos:", error);
                }
            });
            
            conn.on('close', () => {
                console.log(`🔒 Conexión cerrada con:`, peerId);
                connections[peerId].status = 'offline';
                updatePeerList();
                updateConnectedCount();
                updateMonitor(`🔒 DESCONECTADO: ${peerId.substring(0, 8)}`);
                
                if (document.getElementById('autoReconnect')?.checked) {
                    setTimeout(() => {
                        if (peerId !== myPeerId && !connections[peerId]?.conn) {
                            console.log(`🔄 Reconexión automática con ${peerId}`);
                            connectToPeerId(peerId);
                        }
                    }, 3000);
                }
            });
            
            conn.on('error', (err) => {
                console.error(`❌ Error en conexión ${peerId}:`, err);
                connections[peerId].status = 'error';
                updatePeerList();
            });
        }

        function connectToPeerId(peerId) {
            if (!peer || peer.disconnected) {
                console.log("❌ Peer no inicializado");
                return;
            }
            if (connections[peerId] && connections[peerId].status === 'online') {
                console.log("⚠️ Ya conectado a", peerId);
                return;
            }
            
            console.log("🔌 Conectando a:", peerId);
            updateMonitor(`🔌 CONECTANDO A: ${peerId.substring(0, 8)}...`);
            
            try {
                const conn = peer.connect(peerId, {
                    reliable: true,
                    serialization: 'json'
                });
                
                setupConnection(conn, 'outgoing');
                
            } catch (error) {
                console.error(`❌ Error conectando a ${peerId}:`, error);
                updateMonitor(`❌ ERROR CONECTANDO A ${peerId.substring(0, 8)}`);
            }
        }

        function connectToPeer() {
            const input = document.getElementById('peer-id-input');
            const peerId = input.value.trim();
            
            if (!peerId) {
                updateMonitor("⚠️ INGRESA UN ID VÁLIDO", "error");
                playStrongBeep(300, 200);
                return;
            }
            
            input.value = '';
            saveId(peerId);
            connectToPeerId(peerId);
        }

        function handleIncomingConnection(conn) {
            console.log("🔄 Procesando conexión entrante:", conn.peer);
            setupConnection(conn, 'incoming');
        }

        // ====== SISTEMA DE HEALTH CHECKS MEJORADO ======
        
        function startHealthCheckSystem() {
            setInterval(() => {
                if (!isBackground) {
                    checkConnectionsHealth();
                }
            }, 10000);
            
            setInterval(() => {
                const now = Date.now();
                Object.keys(connectionHealth).forEach(peerId => {
                    if (connections[peerId]?.status === 'online') {
                        const lastActivity = connectionHealth[peerId]?.lastActivity || 0;
                        const inactiveTime = now - lastActivity;
                        
                        if (inactiveTime > 15000) {
                            console.log(`⚠️ Conexión ${peerId} inactiva por ${Math.round(inactiveTime/1000)}s`);
                            if (connections[peerId].health !== 'suspicious') {
                                connections[peerId].health = 'suspicious';
                                updatePeerList();
                            }
                        }
                    }
                });
            }, 5000);
        }

        function sendHealthPing(peerId) {
            if (!connections[peerId]?.conn || connections[peerId]?.status !== 'online') return;
            
            try {
                connections[peerId].conn.send({
                    type: 'health_ping',
                    timestamp: Date.now(),
                    sender: myPeerId
                });
                
                console.log(`📡 Ping enviado a ${peerId}`);
                connectionHealth[peerId] = {
                    ...connectionHealth[peerId],
                    lastPing: Date.now(),
                    waitingForPong: true
                };
                
                setTimeout(() => {
                    if (connectionHealth[peerId]?.waitingForPong) {
                        console.log(`❌ No hay respuesta de ${peerId}`);
                        connections[peerId].health = 'unresponsive';
                        updatePeerList();
                    }
                }, 3000);
                
            } catch (error) {
                console.error(`❌ Error enviando ping a ${peerId}:`, error);
                connections[peerId].health = 'error';
                updatePeerList();
            }
        }

        function handleHealthPong(peerId, timestamp) {
            const latency = Date.now() - timestamp;
            
            connectionHealth[peerId] = {
                ...connectionHealth[peerId],
                lastActivity: Date.now(),
                lastLatency: latency,
                waitingForPong: false
            };
            
            connections[peerId].health = 'healthy';
            connections[peerId].latency = latency;
            
            console.log(`✅ Pong recibido de ${peerId} (${latency}ms)`);
            updatePeerList();
            
            document.getElementById('stats-latency').textContent = `${latency} ms`;
        }

        function checkConnectionsHealth() {
            Object.keys(connections).forEach(peerId => {
                if (connections[peerId]?.status === 'online') {
                    const lastActivity = connectionHealth[peerId]?.lastActivity || 0;
                    const inactiveTime = Date.now() - lastActivity;
                    
                    if (inactiveTime > 10000) {
                        sendHealthPing(peerId);
                    }
                }
            });
        }

        // ====== DETECCIÓN DE SEGUNDO PLANO MEJORADA ======
        
        document.addEventListener('visibilitychange', function() {
            isBackground = document.hidden;
            
            console.log(`📱 App ${isBackground ? 'en segundo plano' : 'en primer plano'}`);
            
            if (!isBackground) {
                updateMonitor("⚡ APP REACTIVADA - VERIFICANDO CONEXIONES...");
                playStrongBeep(800, 100);
                
                if (fastRecovery) {
                    setTimeout(() => {
                        reviveAllConnections();
                    }, 500);
                } else {
                    checkConnectionsHealth();
                }
            } else {
                updateMonitor("⏸️ APP EN SEGUNDO PLANO");
            }
        });

        // ====== FUNCIÓN REVIVIR CONEXIONES MEJORADA ======
        
        function reviveAllConnections() {
            if (revivingInProgress) {
                console.log("⚠️ Ya hay una operación de revivir en progreso");
                return;
            }
            
            revivingInProgress = true;
            const reviveBtn = document.getElementById('reviveBtn');
            if (reviveBtn) {
                reviveBtn.classList.add('reviving');
                reviveBtn.disabled = true;
                reviveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> REVIVIENDO...';
            }
            
            updateMonitor("⚡ REVIVIENDO CONEXIONES...");
            playStrongBeep(600, 100);
            
            let revived = 0;
            let suspiciousCount = 0;
            
            Object.keys(connections).forEach(peerId => {
                if (connections[peerId]?.status === 'online' && 
                    (connections[peerId]?.health === 'suspicious' || 
                     connections[peerId]?.health === 'unresponsive')) {
                    suspiciousCount++;
                }
            });
            
            if (suspiciousCount === 0) {
                updateMonitor("✅ TODAS LAS CONEXIONES ESTÁN SALUDABLES");
                finishReviveOperation(reviveBtn, 0);
                return;
            }
            
            updateMonitor(`🔍 ENCONTRADAS ${suspiciousCount} CONEXIÓN(ES) SOSPECHOSAS`);
            
            Object.keys(connections).forEach(peerId => {
                if (connections[peerId]?.status === 'online' && 
                    (connections[peerId]?.health === 'suspicious' || 
                     connections[peerId]?.health === 'unresponsive')) {
                    
                    console.log(`⚡ Reviviendo ${peerId}`);
                    revived++;
                    
                    sendHealthPing(peerId);
                    
                    if (aggressiveRevive) {
                        setTimeout(() => {
                            if (connections[peerId]?.health !== 'healthy') {
                                console.log(`🔁 Reconexión agresiva para ${peerId}`);
                                forceReconnect(peerId);
                            }
                        }, 2000);
                    }
                }
            });
            
            setTimeout(() => {
                updateMonitor(`🔄 REVIVIDAS ${revived} CONEXIÓN(ES)`);
                
                setTimeout(() => {
                    let healthyCount = 0;
                    Object.keys(connections).forEach(peerId => {
                        if (connections[peerId]?.status === 'online' && 
                            connections[peerId]?.health === 'healthy') {
                            healthyCount++;
                        }
                    });
                    
                    updateMonitor(`✅ ${healthyCount} CONEXIÓN(ES) SALUDABLES`);
                    finishReviveOperation(reviveBtn, revived);
                }, 5000);
            }, 3000);
        }

        function forceReconnect(peerId) {
            console.log(`🔁 Forzando reconexión con ${peerId}`);
            
            const shouldReconnect = savedIds.includes(peerId);
            
            if (connections[peerId]?.conn) {
                try {
                    connections[peerId].conn.close();
                } catch (e) {
                    console.error("Error cerrando conexión:", e);
                }
            }
            
            delete connections[peerId];
            delete connectionHealth[peerId];
            
            updatePeerList();
            updateConnectedCount();
            
            if (shouldReconnect) {
                setTimeout(() => {
                    connectToPeerId(peerId);
                    updateMonitor(`🔄 RECONECTANDO: ${peerId.substring(0, 8)}...`);
                }, 1000);
            }
        }

        function finishReviveOperation(reviveBtn, revivedCount) {
            revivingInProgress = false;
            
            if (reviveBtn) {
                reviveBtn.classList.remove('reviving');
                reviveBtn.disabled = false;
                reviveBtn.innerHTML = '<i class="fas fa-heartbeat"></i> REVIVIR CONEXIONES';
            }
            
            if (revivedCount > 0) {
                playStrongBeep(800, 100);
            }
            
            console.log(`✅ Operación de revivir completada: ${revivedCount} conexiones revividas`);
        }

        // ====== REFRESCAR CONEXIONES MEJORADO ======
        
        function refreshAllConnections() {
            console.log("🔄 Refrescando todas las conexiones...");
            updateMonitor("🔄 REFRESCANDO CONEXIONES...", "info");
            playStrongBeep(1000, 200);
            
            const currentPeers = [...savedIds];
            
            Object.keys(connections).forEach(peerId => {
                if (connections[peerId]?.conn) {
                    try {
                        connections[peerId].conn.close();
                    } catch (error) {
                        console.error("Error cerrando conexión:", error);
                    }
                }
            });
            
            connections = {};
            connectionHealth = {};
            
            updatePeerList();
            updateConnectedCount();
            
            setTimeout(() => {
                currentPeers.forEach(peerId => {
                    if (peerId !== myPeerId) {
                        setTimeout(() => connectToPeerId(peerId), 300);
                    }
                });
                updateMonitor("✅ CONEXIONES REFRESCADAS", "info");
            }, 1000);
        }

        // ====== FUNCIONES DE MENSAJERÍA ======

        function handleReceivedData(senderId, data) {
            console.log("🔄 Procesando datos de", senderId, ":", data);
            
            connectionHealth[senderId] = {
                ...connectionHealth[senderId],
                lastActivity: Date.now(),
                lastReceived: Date.now()
            };
            
            if (!data || !data.message) {
                console.log("❌ Datos inválidos");
                return;
            }
            
            const key = document.getElementById('key').value || 'ATOM80';
            const encryption = document.getElementById('encryptionMode').value;
            
            let decryptedMessage = data.message;
            
            if (encryption === 'xor' || encryption === 'aes') {
                decryptedMessage = xorDecrypt(data.message, key);
            }
            
            const displayName = senderId.substring(0, 6);
            displayMessage(`${displayName}: ${decryptedMessage}`, 
                          data.hexPreview || '', 'incoming');
            
            stats.rx += data.message.length;
            stats.messages++;
            updateStats();
            
            updateMonitor(`📥 ${displayName}: "${decryptedMessage.substring(0, 20)}${decryptedMessage.length > 20 ? '...' : ''}"`);
            
            playMessageNotification();
        }

        // ====== FUNCIONES DE UI MEJORADAS ======
        
        function updatePeerList() {
            const container = document.getElementById('saved-peers');
            let html = "";
            
            savedIds.forEach(id => {
                const conn = connections[id];
                let status = conn ? conn.status : 'offline';
                let health = conn ? conn.health : 'offline';
                
                let statusClass = 'st-offline';
                
                if (status === 'online') {
                    if (health === 'healthy') {
                        statusClass = 'st-online';
                    } else if (health === 'suspicious' || health === 'unresponsive') {
                        statusClass = 'st-warning';
                    } else if (health === 'new') {
                        statusClass = 'st-encrypted';
                    }
                }
                
                let statusText = status.toUpperCase();
                if (health === 'suspicious') statusText = 'INACTIVO';
                if (health === 'unresponsive') statusText = 'SIN RESPUESTA';
                
                const displayStyle = (status === 'offline' && !showOffline) ? 'display: none;' : '';
                
                html += `
                    <div class="peer-item ${activeTarget === id ? 'active' : ''}" 
                         data-peer-id="${id}"
                         data-status="${status}"
                         data-health="${health}"
                         onclick="selectPeer('${id}')"
                         style="${displayStyle}">
                        <div class="peer-info">
                            <span class="status-dot ${statusClass}"></span>
                            <div style="display:flex; flex-direction:column;">
                                <span style="font-weight:bold;">${id.substring(0, 8)}</span>
                                <span style="font-size:0.55rem; color:#888;">
                                    ${statusText}
                                    ${conn?.latency ? ` (${conn.latency}ms)` : ''}
                                </span>
                            </div>
                        </div>
                        <span class="del-btn" onclick="event.stopPropagation(); executeRemoveId('${id}')">×</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateConnectionStatusIndicators();
        }

        function updateConnectionStatusIndicators() {
            const onlineHealthy = Object.keys(connections).filter(id => 
                connections[id]?.status === 'online' && 
                connections[id]?.health === 'healthy').length;
            
            const onlineSuspicious = Object.keys(connections).filter(id => 
                connections[id]?.status === 'online' && 
                (connections[id]?.health === 'suspicious' || 
                 connections[id]?.health === 'unresponsive')).length;
            
            const countElement = document.getElementById('connected-count');
            if (countElement) {
                if (onlineHealthy > 0) {
                    countElement.innerHTML = 
                        `<span style="color:#00ff88">${onlineHealthy}</span>` + 
                        (onlineSuspicious > 0 ? `<span style="color:#ffaa00">/${onlineSuspicious}</span>` : '');
                } else if (onlineSuspicious > 0) {
                    countElement.innerHTML = `<span style="color:#ffaa00">${onlineSuspicious}</span>`;
                } else {
                    countElement.innerHTML = '0';
                }
            }
            
            document.getElementById('stats-connections').textContent = onlineHealthy + onlineSuspicious;
        }

        function toggleShowOffline() {
            showOffline = !showOffline;
            updatePeerList();
            
            const icon = document.querySelector('#saved-peers-container').parentElement
                .querySelector('.fa-eye-slash, .fa-eye');
            if (icon) {
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            }
            
            updateMonitor(showOffline ? "👁️ MOSTRANDO OFFLINE" : "👁️ OCULTANDO OFFLINE");
            playStrongBeep(600, 50);
        }

        function selectPeer(id) {
            if (id !== 'GLOBAL' && connections[id]?.health === 'suspicious') {
                sendHealthPing(id);
            }
            
            activeTarget = id;
            
            document.querySelectorAll('.peer-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (id === 'GLOBAL') {
                document.getElementById('target-global').classList.add('active');
            } else {
                const peerElement = document.querySelector(`[data-peer-id="${id}"]`);
                if (peerElement) {
                    peerElement.classList.add('active');
                }
            }
            
            document.getElementById('target-display').innerHTML = 
                `<i class="fas fa-crosshairs"></i> DESTINO: ${id === 'GLOBAL' ? "GLOBAL" : id.substring(0, 8)}`;
        }

        // ====== FUNCIONES AUXILIARES MEJORADAS ======
        
        function saveId(id) {
            if (!savedIds.includes(id) && id !== myPeerId) {
                savedIds.push(id);
                localStorage.setItem('radcom_peers_v4', JSON.stringify(savedIds));
                updatePeerList();
            }
        }

        function executeRemoveId(id) {
            if (!confirm(`¿Eliminar ${id.substring(0, 8)} del historial?`)) {
                return;
            }
            
            console.log("🗑️ Eliminando ID:", id);
            
            savedIds = savedIds.filter(savedId => savedId !== id);
            localStorage.setItem('radcom_peers_v4', JSON.stringify(savedIds));
            
            if (connections[id]) {
                if (connections[id].conn) {
                    connections[id].conn.close();
                }
                delete connections[id];
                delete connectionHealth[id];
            }
            
            if (activeTarget === id) {
                activeTarget = 'GLOBAL';
                document.getElementById('target-display').innerHTML = 
                    '<i class="fas fa-crosshairs"></i> DESTINO: GLOBAL';
                document.getElementById('target-global').classList.add('active');
            }
            
            updatePeerList();
            updateConnectedCount();
            
            updateMonitor(`🗑️ ELIMINADO: ${id.substring(0, 8)}`);
            playStrongBeep(300, 100);
        }

        function updateConnectedCount() {
            const onlineCount = Object.keys(connections).filter(id => 
                connections[id]?.status === 'online').length;
            document.getElementById('stats-connections').textContent = onlineCount;
        }

        function displayMessage(content, hex, type) {
            const monitor = document.getElementById('monitor-decoded');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message-bubble message-${type}`;
            
            let displayContent = content;
            if (content.length > 150) {
                displayContent = content.substring(0, 150) + '...';
            }
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            
            messageDiv.innerHTML = `
                <div style="margin-bottom:1px;">
                    <span style="color:#${type === 'outgoing' ? '0088ff' : type === 'incoming' ? 'ff3300' : '00ff88'}">
                        ${time}
                    </span>
                </div>
                <div>${escapeHtml(displayContent)}</div>
                ${hex ? `<div style="font-size:0.55rem; color:#888; margin-top:1px;">
                    <i class="fas fa-code"></i> ${hex}</div>` : ''}
            `;
            
            monitor.appendChild(messageDiv);
            monitor.scrollTop = monitor.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateMonitor(message, type = 'info') {
            const monitor = document.getElementById('monitor-raw');
            const color = type === 'error' ? '#ff3300' : 
                         type === 'warning' ? '#ffaa00' : '#00ff88';
            
            monitor.innerHTML = `<span style="color:${color}">${message}</span>`;
        }

        // ====== SONIDOS ======
        
        function playStrongBeep(freq, duration) {
            if (!document.getElementById('soundEnabled')?.checked) return;
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = freq;
            oscillator.type = 'sawtooth';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }
        
        function playMessageNotification() {
            if (!document.getElementById('soundEnabled')?.checked) return;
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            let currentTime = audioContext.currentTime;
            
            [800, 1200, 1000].forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = freq;
                oscillator.type = 'sawtooth';
                
                gainNode.gain.setValueAtTime(0.4, currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, currentTime + 0.15);
                
                oscillator.start(currentTime);
                oscillator.stop(currentTime + 0.15);
                
                currentTime += 0.2;
            });
        }

        // ====== FUNCIONES RESTANTES ======
        
        function generateKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let key = '';
            for (let i = 0; i < 12; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('key').value = key;
            document.getElementById('key').type = 'text';
            
            setTimeout(() => {
                document.getElementById('key').type = 'password';
            }, 2000);
            
            return key;
        }

        function copyID() {
            if (!myPeerId) {
                alert('Espera a que se genere el ID primero');
                return;
            }
            
            navigator.clipboard.writeText(myPeerId).then(() => {
                updateMonitor(`📋 ID COPIADO: ${myPeerId.substring(0, 12)}...`);
                playStrongBeep(800, 100);
            });
        }

        function updateUptime() {
            const elapsed = Date.now() - stats.startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            document.getElementById('stats-uptime').textContent = 
                `${hours.toString().padStart(2, '0')}:` +
                `${minutes.toString().padStart(2, '0')}:` +
                `${seconds.toString().padStart(2, '0')}`;
        }

        function updateStats() {
            document.getElementById('stats-messages').textContent = stats.messages;
            document.getElementById('data-session').textContent = stats.tx + stats.rx;
            
            document.getElementById('stats-tx').textContent = formatBytes(stats.tx);
            document.getElementById('stats-rx').textContent = formatBytes(stats.rx);
            
            const elapsed = (Date.now() - stats.startTime) / 1000;
            const bandwidth = elapsed > 0 ? (stats.tx + stats.rx) / elapsed / 1024 : 0;
            document.getElementById('stats-bandwidth').textContent = 
                `${bandwidth.toFixed(2)} KB/s`;
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function validateInput() {
            const input = document.getElementById('inputMsg');
            const mode = document.getElementById('inputMode').value;
            const value = input.value.trim();
            
            input.classList.remove('invalid');
            
            if (mode === 'hex') {
                const hexRegex = /^[0-9a-fA-F\s]*$/;
                if (!hexRegex.test(value)) {
                    input.classList.add('invalid');
                    return false;
                }
            } else if (mode === 'binary') {
                const binRegex = /^[01\s]*$/;
                if (!binRegex.test(value)) {
                    input.classList.add('invalid');
                    return false;
                }
            }
            
            return true;
        }

        function validateInputMode() {
            const input = document.getElementById('inputMsg');
            const mode = document.getElementById('inputMode').value;
            
            if (mode === 'text') {
                input.placeholder = "INYECTAR DATOS SEGUROS...";
            } else if (mode === 'hex') {
                input.placeholder = "INGRESA HEX (0-9, A-F)...";
            } else if (mode === 'binary') {
                input.placeholder = "INGRESA BINARIO (0-1)...";
            } else if (mode === 'morse') {
                input.placeholder = "ESCRIBE CÓDIGO MORSE (. y -) o texto...";
            } else if (mode === 'phonetic') {
                input.placeholder = "INGRESA TEXTO PARA FONÉTICO...";
            } else if (mode === 'satellite') {
                input.placeholder = "PREPARADO PARA SATÉLITE...";
            }
            
            input.value = '';
            validateInput();
        }

        function realTimePreview() {
            clearTimeout(window.previewTimeout);
            window.previewTimeout = setTimeout(() => {
                const input = document.getElementById('inputMsg');
                const message = input.value;
                
                if (!message) {
                    updateMonitor("ESCUCHA ACTIVA...");
                    return;
                }
                
                const key = document.getElementById('key').value || 'ATOM80';
                let hex = '';
                for (let i = 0; i < Math.min(message.length, 3); i++) {
                    const charCode = message.charCodeAt(i);
                    const keyCode = key.charCodeAt(i % key.length);
                    hex += (charCode ^ keyCode).toString(16).padStart(2, '0');
                }
                
                updateMonitor(`PREVIEW: ${hex}...`);
            }, 300);
        }

        function realTimeTableHighlight() {
            const input = document.getElementById('inputMsg');
            const text = input.value;
            
            document.querySelectorAll('#ansiTable td.highlighted').forEach(td => {
                td.classList.remove('highlighted');
            });
            
            if (text.length === 0) {
                return;
            }
            
            const lastChar = text[text.length - 1];
            const asciiCode = lastChar.charCodeAt(0);
            
            if (asciiCode >= 32 && asciiCode <= 126) {
                const row = asciiCode & 0x0F;
                const col = (asciiCode >> 4) & 0x07;
                
                const cell = document.querySelector(`#ansiTable td[data-ascii="${asciiCode}"]`);
                if (cell) {
                    cell.classList.add('highlighted');
                    
                    const displayChar = cell.getAttribute('data-char');
                    const hex = cell.getAttribute('data-hex');
                    updateCharPreview(row, col, asciiCode, hex, displayChar);
                    
                    cell.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                }
            } else if (lastChar === ' ') {
                const cell = document.querySelector('#ansiTable td[data-char="SPC"]');
                if (cell) {
                    cell.classList.add('highlighted');
                    const row = parseInt(cell.getAttribute('data-row'));
                    const col = parseInt(cell.getAttribute('data-col'));
                    const ascii = parseInt(cell.getAttribute('data-ascii'));
                    const hex = cell.getAttribute('data-hex');
                    updateCharPreview(row, col, ascii, hex, 'SPC');
                }
            } else if (lastChar === '\x7F') {
                const cell = document.querySelector('#ansiTable td[data-char="DEL"]');
                if (cell) {
                    cell.classList.add('highlighted');
                    const row = parseInt(cell.getAttribute('data-row'));
                    const col = parseInt(cell.getAttribute('data-col'));
                    const ascii = parseInt(cell.getAttribute('data-ascii'));
                    const hex = cell.getAttribute('data-hex');
                    updateCharPreview(row, col, ascii, hex, 'DEL');
                }
            }
        }

        function clearChat() {
            if (confirm("¿Borrar todo el historial del chat?")) {
                document.getElementById('monitor-decoded').innerHTML = 
                    '<div class="message-bubble message-system"><i class="fas fa-satellite"></i> HISTORIAL LIMPIADO</div>';
                updateMonitor("✅ CHAT LIMPIADO");
                playStrongBeep(400, 200);
            }
        }

        // ====== CONFIGURACIÓN MEJORADA ======
        
        function showSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
            updateConnectionUI();
            loadIdSettings();
        }

        function hideSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function updateConnectionUI() {
            document.querySelectorAll('.connection-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`btn-${currentConnectionType}`).classList.add('active');
            
            const typeName = currentConnectionType === 'wifi' ? 'WiFi' : 'Datos Móviles';
            document.getElementById('current-connection-type').textContent = typeName;
        }

        function selectConnectionType(type) {
            if (type === currentConnectionType) return;
            
            document.querySelectorAll('.connection-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`btn-${type}`).classList.add('active');
            
            currentConnectionType = type;
            const typeName = type === 'wifi' ? 'WiFi' : 'Datos Móviles';
            document.getElementById('current-connection-type').textContent = typeName;
            
            updateMonitor(`⚡ Modo conexión cambiado a: ${typeName}`);
            playStrongBeep(800, 100);
            
            saveConnectionType();
        }

        function saveConnectionType() {
            const config = JSON.parse(localStorage.getItem('radcom_config_v4.6') || '{}');
            config.connectionType = currentConnectionType;
            localStorage.setItem('radcom_config_v4.6', JSON.stringify(config));
        }

        // ====== FUNCIONES DE CONFIGURACIÓN DE ID ======
        
        function loadIdSettings() {
            const config = JSON.parse(localStorage.getItem('radcom_config_v4') || '{}');
            
            document.getElementById('useFixedId').checked = config.useFixedId !== false;
            document.getElementById('customIdInput').value = config.fixedId || getOrCreateFixedId();
            document.getElementById('currentIdDisplay').textContent = ID_SYSTEM.currentId || 'No asignado';
            
            toggleIdMode();
        }

        function toggleIdMode() {
            const useFixed = document.getElementById('useFixedId').checked;
            const container = document.getElementById('customIdContainer');
            
            if (useFixed) {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        function generateCustomId() {
            const prefixes = ['RADCOM', 'SATCOM', 'NETCOM', 'SECURE', 'MASTER'];
            const adjectives = ['ALPHA', 'BRAVO', 'CHARLIE', 'DELTA', 'ECHO', 'FOXTROT'];
            const nouns = ['STATION', 'NODE', 'HUB', 'RELAY', 'TERMINAL'];
            
            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            const number = Math.floor(Math.random() * 999).toString().padStart(3, '0');
            
            const generatedId = `${prefix}-${adj}-${noun}-${number}`;
            document.getElementById('customIdInput').value = generatedId;
        }

        function applyIdSettings() {
            const useFixed = document.getElementById('useFixedId').checked;
            const customId = document.getElementById('customIdInput').value.trim();
            
            if (useFixed && (!customId || customId.length < 3)) {
                updateMonitor("⚠️ ID PERSONALIZADO INVÁLIDO", "error");
                playStrongBeep(300, 200);
                return;
            }
            
            const config = JSON.parse(localStorage.getItem('radcom_config_v4.6') || '{}');
            config.useFixedId = useFixed;
            
            if (useFixed) {
                config.fixedId = customId;
            } else {
                config.fixedId = null;
            }
            
            localStorage.setItem('radcom_config_v4', JSON.stringify(config));
            
            ID_SYSTEM.useFixedId = useFixed;
            ID_SYSTEM.fixedId = useFixed ? customId : null;
            
            updateMonitor(`🔄 APLICANDO NUEVA CONFIGURACIÓN DE ID...`);
            
            setTimeout(() => {
                if (peer) {
                    peer.destroy();
                }
                setTimeout(() => initPeerJSEnhanced(), 1000);
            }, 500);
            
            hideSettings();
        }

        function resetIdSettings() {
            const defaultId = generateHardwareBasedId();
            document.getElementById('customIdInput').value = defaultId;
            document.getElementById('useFixedId').checked = true;
            toggleIdMode();
            updateMonitor("🔄 ID RESTABLECIDO A VALOR PREDETERMINADO");
        }

        function saveSettings() {
            const config = {
                systemName: document.getElementById('systemName').value,
                connectionType: currentConnectionType,
                autoReconnect: document.getElementById('autoReconnect').checked,
                soundEnabled: document.getElementById('soundEnabled').checked,
                saveHistory: document.getElementById('saveHistory').checked,
                fastRecovery: document.getElementById('fastRecovery').checked,
                aggressiveRevive: document.getElementById('aggressiveRevive').checked,
                useFixedId: document.getElementById('useFixedId').checked,
                fixedId: document.getElementById('customIdInput').value.trim()
            };
            
            localStorage.setItem('radcom_config_v4', JSON.stringify(config));
            
            fastRecovery = config.fastRecovery;
            aggressiveRevive = config.aggressiveRevive;
            ID_SYSTEM.useFixedId = config.useFixedId;
            
            if (config.fixedId && config.useFixedId) {
                ID_SYSTEM.fixedId = config.fixedId;
                localStorage.setItem('radcom_fixed_id_v4', config.fixedId);
            }
            
            updateMonitor("✅ CONFIGURACIÓN GUARDADA");
            hideSettings();
            playStrongBeep(600, 100);
        }

        function loadSettings() {
            const config = JSON.parse(localStorage.getItem('radcom_config_v4.6') || '{}');
            
            if (config.systemName) {
                document.getElementById('systemName').value = config.systemName;
            }
            if (config.connectionType) {
                currentConnectionType = config.connectionType;
            }
            if (config.autoReconnect !== undefined) {
                document.getElementById('autoReconnect').checked = config.autoReconnect;
            }
            if (config.soundEnabled !== undefined) {
                document.getElementById('soundEnabled').checked = config.soundEnabled;
            }
            if (config.saveHistory !== undefined) {
                document.getElementById('saveHistory').checked = config.saveHistory;
            }
            if (config.fastRecovery !== undefined) {
                document.getElementById('fastRecovery').checked = config.fastRecovery;
                fastRecovery = config.fastRecovery;
            }
            if (config.aggressiveRevive !== undefined) {
                document.getElementById('aggressiveRevive').checked = config.aggressiveRevive;
                aggressiveRevive = config.aggressiveRevive;
            }
            if (config.useFixedId !== undefined) {
                ID_SYSTEM.useFixedId = config.useFixedId;
            }
            if (config.fixedId) {
                ID_SYSTEM.fixedId = config.fixedId;
            }
        }

        function initResizableSeparator() {
            const separator = document.getElementById('resizableSeparator');
            const monitorContainer = document.getElementById('monitorContainer');
            const tableContainer = document.getElementById('tableContainer');
            
            let isResizing = false;
            let startY, startHeight, startTableHeight;
            
            separator.addEventListener('mousedown', function(e) {
                isResizing = true;
                startY = e.clientY;
                startHeight = parseInt(getComputedStyle(monitorContainer).height);
                startTableHeight = parseInt(getComputedStyle(tableContainer).height);
                
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
            });
            
            function resize(e) {
                if (!isResizing) return;
                
                const delta = e.clientY - startY;
                let newHeight = startHeight + delta;
                
                if (newHeight < 150) newHeight = 150;
                if (newHeight > 400) newHeight = 400;
                
                monitorContainer.style.height = newHeight + 'px';
                
                const tableNewHeight = newHeight - 80;
                if (tableNewHeight > 80) {
                    tableContainer.style.height = tableNewHeight + 'px';
                }
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
                
                const currentHeight = parseInt(getComputedStyle(monitorContainer).height);
                localStorage.setItem('radcom_separator_height', currentHeight);
            }
            
            const savedHeight = localStorage.getItem('radcom_separator_height');
            if (savedHeight) {
                monitorContainer.style.height = savedHeight + 'px';
            }
        }

        // ====== INICIALIZACIÓN ======
        
        window.onload = function() {
            console.log(`🚀 Iniciando ${SYSTEM_NAME} v${VERSION}`);
            
            buildAsciiTable();
            buildMorseTable();
            initRadioSystem();
            buildSatelliteTable();
            loadSettings();
            updatePeerList();
            initResizableSeparator();
            initMorseAudio();
            initVoiceRecognition();
            
            initPeerJSEnhanced();
            startHealthCheckSystem();
            
            document.getElementById('inputMsg').addEventListener('keydown', handleSendMessage);
        };

        // ====== MÓDULO DE MEMORIA RADCOM v4.7 ======

function saveToLocalStorage(sender, msg) {
    let history = JSON.parse(localStorage.getItem('radcom_history_v47') || "[]");
    history.push({
        time: new Date().toLocaleTimeString(),
        sender: sender,
        text: msg
    });
    if(history.length > 30) history.shift(); // Guardar últimos 30 mensajes
    localStorage.setItem('radcom_history_v47', JSON.stringify(history));
}

function loadHistoryFromLocal() {
    let history = JSON.parse(localStorage.getItem('radcom_history_v47') || "[]");
    if(history.length > 0) {
        updateMonitor("📂 RECUPERANDO MENSAJES GUARDADOS...");
        history.forEach(item => {
            // Se muestran en el log pero con un estilo más apagado (dimmed)
            const logContainer = document.getElementById('logContainer');
            if(logContainer) {
                const div = document.createElement('div');
                div.style.borderLeft = "2px solid #333";
                div.style.paddingLeft = "5px";
                div.style.marginBottom = "2px";
                div.style.color = "#00aa66"; 
                div.innerHTML = `<small>[Historial ${item.time}]</small> <b>${item.sender}:</b> ${item.text}`;
                logContainer.appendChild(div);
            }
        });
    }
}
    </script>
    
    <!-- Iconos de FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>
